<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BUNCA • Cleaning Plan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#f4f6f8}.brandbar{background:#1f7a3f}</style>
</head>
<body>
<nav class="navbar navbar-dark brandbar"><div class="container">
  <a class="navbar-brand fw-bold" href="/index.html">BUNCA HACCP</a>
  <div class="d-flex gap-2 ms-auto">
    <select id="shopSelect" class="form-select form-select-sm"></select>
    <a class="btn btn-outline-light btn-sm" href="/index.html">Zurück</a>
  </div>
</div></nav>

<main class="container my-4">
  <h1 class="h4 mb-3">Cleaning Plan – <span id="dateSpan"></span></h1>
  <div class="card">
    <div class="table-responsive">
      <table class="table align-middle mb-0" id="tbl">
        <thead class="table-light"><tr><th>Fertig</th><th>Aufgabe</th><th>Bereich</th><th>Frequenz</th><th>Notiz</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="p-3 d-flex gap-2">
      <button id="btnSave" class="btn btn-success">Speichern</button>
      <div class="small text-muted ms-auto" id="saveInfo">–</div>
    </div>
  </div>
</main>

<script>
  const token = localStorage.getItem('token'); if (!token){ alert('Bitte anmelden'); location.href='/index.html'; }
  const headers = { Authorization: 'Bearer '+token, 'Content-Type':'application/json' };
  const $ = s=>document.querySelector(s);
  function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  async function loadShops(){ const r=await fetch('/api/shops',{headers}); const shops=await r.json(); $('#shopSelect').innerHTML=shops.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }

  let _plan = [], _tasks = [], _shopId = null, _date = todayStr();
  async function loadDay(){
    _shopId = $('#shopSelect').value || 'shop_default';
    $('#dateSpan').textContent = _date;
    const r=await fetch(`/api/cleaning?shopId=${encodeURIComponent(_shopId)}&date=${_date}`,{headers});
    const d = await r.json();
    _plan = d.plan || [];
    _tasks = d.tasks || _plan.map(t=>({ id:t.id, done:false, note:'' }));
    const body = _plan.map(p=>{
      const t = _tasks.find(x=>x.id===p.id) || {done:false,note:''};
      return `<tr>
        <td><input type="checkbox" class="form-check-input" data-id="${p.id}" ${t.done?'checked':''}></td>
        <td>${p.name}</td><td>${p.area||''}</td><td>${p.freq}</td>
        <td><input class="form-control form-control-sm" data-note="${p.id}" value="${t.note||''}" placeholder="optional"></td>
      </tr>`;
    }).join('');
    document.querySelector('#tbl tbody').innerHTML = body;
  }

  $('#shopSelect').onchange = loadDay;
  $('#btnSave').onclick = async ()=>{
    const tasks = _plan.map(p=>{
      const done = document.querySelector(`input[data-id="${p.id}"]`).checked;
      const note = document.querySelector(`input[data-note="${p.id}"]`).value;
      return { id:p.id, done, note };
    });
    const r=await fetch('/api/cleaning',{method:'POST', headers, body:JSON.stringify({ date:_date, shopId:_shopId, tasks })});
    const data = await r.json(); if(!r.ok){ alert(data.error||'Fehler'); return; }
    document.getElementById('saveInfo').textContent='Gespeichert ✔︎';
  };

  (async function(){ await loadShops(); await loadDay(); })();
</script>
</body>
</html>
