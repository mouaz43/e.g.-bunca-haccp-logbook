<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BUNCA • Cleaning Plan</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/style.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-dark brandbar"><div class="container">
  <a class="navbar-brand fw-bold" href="/index.html"><i class="bi bi-shield-check me-2"></i>BUNCA HACCP</a>
  <div class="d-flex gap-2 ms-auto">
    <select id="shopSelect" class="form-select form-select-sm"></select>
    <a class="btn btn-outline-light btn-sm" href="/index.html"><i class="bi bi-arrow-left"></i> Zurück</a>
  </div>
</div></nav>

<main class="container my-4">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h1 class="h5 mb-0">Cleaning Plan – <span id="dateSpan"></span></h1>
    <div class="w-50 ms-3">
      <div class="progress thin"><div id="bar" class="progress-bar" style="width:0%"></div></div>
      <div class="small smallmuted"><span id="countText">0/0 erledigt</span></div>
    </div>
  </div>

  <div id="groups" class="d-grid gap-3"></div>

  <div class="card card-shadow mt-3">
    <div class="p-3 d-flex gap-2">
      <button id="btnSave" class="btn btn-brand"><i class="bi bi-save"></i> Speichern</button>
      <div class="small smallmuted ms-auto" id="saveInfo">–</div>
    </div>
  </div>
</main>

<script>
  const token = localStorage.getItem('token'); if (!token){ alert('Bitte anmelden'); location.href='/index.html'; }
  const headers = { Authorization: 'Bearer '+token, 'Content-Type':'application/json' };
  const $ = s=>document.querySelector(s);
  function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  async function loadShops(){ const r=await fetch('/api/shops',{headers}); const shops=await r.json(); $('#shopSelect').innerHTML=shops.map(s=>`<option value="${s.id}">${s.name}</option>`).join(''); }

  let _plan = [], _tasks = [], _shopId = null, _date = todayStr();
  $('#dateSpan').textContent = _date;

  function groupBy(arr, key){ return arr.reduce((m,x)=>((m[x[key]]=m[x[key]]||[]).push(x),m),{}); }

  function render(){
    const groups = groupBy(_plan,'freq'); // daily/weekly/monthly
    const wrap = $('#groups'); wrap.innerHTML = '';

    ['daily','weekly','monthly'].forEach(freq=>{
      if(!groups[freq]) return;
      const rows = groups[freq].map(p=>{
        const t = _tasks.find(x=>x.id===p.id) || {done:false,note:''};
        return `<tr>
          <td class="text-center" style="width:56px"><input type="checkbox" class="form-check-input" data-id="${p.id}" ${t.done?'checked':''}></td>
          <td>${p.name}<div class="smallmuted">${p.area||''}</div></td>
          <td style="width:220px"><input class="form-control form-control-sm" data-note="${p.id}" value="${t.note||''}" placeholder="Notiz (optional)"></td>
        </tr>`;
      }).join('');

      const card = document.createElement('div');
      card.className='card card-shadow';
      card.innerHTML = `
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold text-capitalize">${freq}</div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" data-clear="${freq}"><i class="bi bi-x-circle"></i> Alle leer</button>
            <button class="btn btn-sm btn-outline-success" data-all="${freq}"><i class="bi bi-check2-all"></i> Alle erledigt</button>
          </div>
        </div>
        <div class="table-responsive"><table class="table align-middle mb-0"><tbody>${rows}</tbody></table></div>`;
      wrap.appendChild(card);
    });

    wrap.querySelectorAll('[data-all]').forEach(b=>b.onclick=()=>toggleGroup(b.dataset.all,true));
    wrap.querySelectorAll('[data-clear]').forEach(b=>b.onclick=()=>toggleGroup(b.dataset.clear,false));
    updateProgress();
  }

  function toggleGroup(freq, done){
    groupBy(_plan,'freq')[freq].forEach(p=>{
      const box = document.querySelector(`input[data-id="${p.id}"]`);
      if (box) box.checked = done;
    });
    updateProgress();
  }

  function updateProgress(){
    const allIds = _plan.map(p=>p.id);
    const done = allIds.filter(id => document.querySelector(`input[data-id="${id}"]`)?.checked).length;
    const total = allIds.length || 1;
    $('#bar').style.width = (100*done/total) + '%';
    $('#countText').textContent = `${done}/${total} erledigt`;
  }

  async function loadDay(){
    _shopId = $('#shopSelect').value || 'shop_default';
    const r=await fetch(`/api/cleaning?shopId=${encodeURIComponent(_shopId)}&date=${_date}`,{headers});
    const d = await r.json();
    _plan = d.plan || [];
    _tasks = d.tasks || _plan.map(t=>({ id:t.id, done:false, note:'' }));
    render();
  }

  $('#shopSelect').onchange = loadDay;

  $('#btnSave').onclick = async ()=>{
    const tasks = _plan.map(p=>{
      const done = document.querySelector(`input[data-id="${p.id}"]`).checked;
      const note = document.querySelector(`input[data-note="${p.id}"]`).value;
      return { id:p.id, done, note };
    });
    const r=await fetch('/api/cleaning',{method:'POST', headers, body:JSON.stringify({ date:_date, shopId:_shopId, tasks })});
    const data = await r.json(); if(!r.ok){ alert(data.error||'Fehler'); return; }
    $('#saveInfo').textContent='Gespeichert ✔︎';
  };

  (async function(){ await loadShops(); await loadDay(); })();
</script>
</body>
</html>
