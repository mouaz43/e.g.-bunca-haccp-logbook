<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BUNCA HACCP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="/public/logo.svg">
  <style>
    body{background:#f4f6f8}
    .brandbar{background:#1f7a3f}
    .card-shadow{box-shadow:0 10px 25px rgba(0,0,0,.06)}
    .login-card{max-width:480px}
    .metric{font-weight:700;font-size:28px}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark brandbar">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">BUNCA HACCP</a>
      <div class="d-flex gap-2">
        <select id="shopSelect" class="form-select form-select-sm"></select>
        <a id="adminLink" class="btn btn-outline-light btn-sm d-none" href="/admin.html">Admin</a>
        <button id="btnLogout" class="btn btn-light btn-sm d-none">Abmelden</button>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <!-- Login -->
    <div id="loginBox" class="card card-shadow login-card mx-auto">
      <div class="card-body">
        <h3 class="h4 mb-3">Anmelden</h3>
        <div class="mb-2"><label class="form-label">E-Mail</label><input id="loginEmail" class="form-control" value=""></div>
        <div class="mb-3"><label class="form-label">Passwort</label><input id="loginPass" type="password" class="form-control"></div>
        <button id="btnLogin" class="btn btn-success">Login</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dash" class="d-none">
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="card card-shadow p-3">
            <div class="text-muted">Checks (heute)</div>
            <div class="metric" id="checksCount">0/0</div>
            <div class="small text-muted" id="lastSaved">zuletzt gespeichert: –</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-shadow p-3">
            <div class="text-muted">Abweichungen</div>
            <div class="metric text-warning" id="deviations">0</div>
            <div class="small text-muted">Grenzwerte beachten</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-shadow p-3">
            <div class="text-muted">Offene Issues (heute)</div>
            <div class="metric" id="issuesToday">0</div>
            <a class="small" id="historyLink" href="/historie.html">Historie & Export</a>
          </div>
        </div>
      </div>

      <div class="card card-shadow">
        <div class="card-body">
          <h5 class="card-title">HACCP Tages-Checkliste <span id="todaySpan"></span></h5>

          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Kühlschrank 1 (0–7°C)</label>
              <div class="input-group">
                <input id="fr1" type="number" step="0.1" class="form-control" placeholder="z. B. 4.2">
                <span class="input-group-text">°C</span>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Kühlschrank 2 (0–7°C)</label>
              <div class="input-group">
                <input id="fr2" type="number" step="0.1" class="form-control" placeholder="z. B. 5.0">
                <span class="input-group-text">°C</span>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Tiefkühler (≤ −18°C)</label>
              <div class="input-group">
                <input id="fz" type="number" step="0.1" class="form-control" placeholder="-18">
                <span class="input-group-text">°C</span>
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Ofen/Backstation (≥ 180°C)</label>
              <div class="input-group">
                <input id="ov" type="number" step="1" class="form-control" placeholder="180">
                <span class="input-group-text">°C</span>
              </div>
            </div>

            <div class="col-md-4">
              <div class="form-check mt-4">
                <input id="dw" class="form-check-input" type="checkbox">
                <label class="form-check-label" for="dw">Spülmaschine Spültemperatur ≥ 82°C</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check mt-4">
                <input id="hw" class="form-check-input" type="checkbox">
                <label class="form-check-label" for="hw">Handwaschbecken Warmwasser vorhanden</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check mt-4">
                <input id="cl" class="form-check-input" type="checkbox">
                <label class="form-check-label" for="cl">Reinigungsplan erledigt</label>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Notizen / Issues</label>
              <textarea id="notes" class="form-control" rows="3" placeholder="z. B. Kühlschrank 2 schließt nicht richtig…"></textarea>
            </div>

            <div class="col-12 d-flex gap-2">
              <button id="btnReset" class="btn btn-outline-secondary">Zurücksetzen</button>
              <button id="btnSave" class="btn btn-success">Speichern</button>
              <div class="ms-auto small text-muted align-self-center" id="saveInfo">–</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // --- helpers
  const $ = s => document.querySelector(s);
  const token = localStorage.getItem('token');
  const role  = localStorage.getItem('role');

  function setAuthUI() {
    const logged = !!token;
    $('#loginBox').classList.toggle('d-none', logged);
    $('#dash').classList.toggle('d-none', !logged);
    $('#btnLogout').classList.toggle('d-none', !logged);
    $('#adminLink').classList.toggle('d-none', !(role === 'admin'));
  }
  setAuthUI();

  $('#btnLogin').onclick = async () => {
    const email = $('#loginEmail').value.trim();
    const password = $('#loginPass').value;
    const r = await fetch('/api/auth/login', {
      method:'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ email, password })
    });
    const data = await r.json();
    if (!r.ok) return alert(data.error || 'Login fehlgeschlagen');
    localStorage.setItem('token', data.token);
    localStorage.setItem('role', data.role || 'staff');
    location.reload();
  };

  $('#btnLogout').onclick = () => {
    localStorage.removeItem('token'); localStorage.removeItem('role');
    location.reload();
  };

  async function authFetch(url, opts={}) {
    const h = opts.headers || {};
    h['Authorization'] = 'Bearer ' + localStorage.getItem('token');
    if (!h['Content-Type'] && opts.method && opts.method !== 'GET') h['Content-Type'] = 'application/json';
    const r = await fetch(url, { ...opts, headers: h });
    if (r.status === 401) { alert('Bitte neu anmelden.'); location.reload(); }
    return r;
  }

  // shops dropdown
  async function loadShops() {
    const r = await authFetch('/api/shops');
    const shops = await r.json();
    $('#shopSelect').innerHTML = shops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  }

  function todayStr() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }

  async function loadToday() {
    const shopId = $('#shopSelect').value || 'shop_default';
    $('#todaySpan').textContent = todayStr();
    const r = await authFetch(`/api/today?shopId=${encodeURIComponent(shopId)}`);
    const d = await r.json();

    $('#fr1').value = d.readings.fridge1 ?? '';
    $('#fr2').value = d.readings.fridge2 ?? '';
    $('#fz').value  = d.readings.freezer ?? '';
    $('#ov').value  = d.readings.oven ?? '';
    $('#dw').checked = !!d.readings.dishwasherOver82C;
    $('#hw').checked = !!d.readings.handwashHot;
    $('#cl').checked = !!d.readings.cleaningDone;
    $('#notes').value = d.notes || '';

    const total = 7; // 4 temps + 3 checks
    let done = 0;
    if (d.readings.fridge1 !== null && d.readings.fridge1 !== '') done++;
    if (d.readings.fridge2 !== null && d.readings.fridge2 !== '') done++;
    if (d.readings.freezer !== null && d.readings.freezer !== '') done++;
    if (d.readings.oven !== null && d.readings.oven !== '') done++;
    if (d.readings.dishwasherOver82C) done++;
    if (d.readings.handwashHot) done++;
    if (d.readings.cleaningDone) done++;
    $('#checksCount').textContent = `${done}/${total}`;

    let dev = 0;
    const t = d.targets || { fridge1Min:0, fridge1Max:7, fridge2Min:0, fridge2Max:7, freezerMax:-18, ovenMin:180 };
    if (d.readings.fridge1 != null && (d.readings.fridge1 < t.fridge1Min || d.readings.fridge1 > t.fridge1Max)) dev++;
    if (d.readings.fridge2 != null && (d.readings.fridge2 < t.fridge2Min || d.readings.fridge2 > t.fridge2Max)) dev++;
    if (d.readings.freezer  != null && d.readings.freezer > t.freezerMax) dev++;
    if (d.readings.oven     != null && d.readings.oven < t.ovenMin) dev++;
    $('#deviations').textContent = dev;

    $('#issuesToday').textContent = (d.issues||[]).length;
    $('#lastSaved').textContent = d.lastSavedAt ? new Date(d.lastSavedAt).toLocaleString() : '–';
  }

  $('#shopSelect').onchange = loadToday;
  $('#btnReset').onclick = loadToday;

  $('#btnSave').onclick = async () => {
    const body = {
      date: todayStr(),
      shopId: $('#shopSelect').value || 'shop_default',
      readings: {
        fridge1: $('#fr1').value === '' ? null : Number($('#fr1').value),
        fridge2: $('#fr2').value === '' ? null : Number($('#fr2').value),
        freezer: $('#fz').value === '' ? null : Number($('#fz').value),
        oven:    $('#ov').value === '' ? null : Number($('#ov').value),
        dishwasherOver82C: $('#dw').checked,
        handwashHot: $('#hw').checked,
        cleaningDone: $('#cl').checked
      },
      notes: $('#notes').value.trim(),
      issues: $('#notes').value.trim() ? [$('#notes').value.trim()] : []
    };
    const r = await authFetch('/api/today', { method:'POST', body: JSON.stringify(body) });
    const data = await r.json();
    if (!r.ok) return alert(data.error || 'Fehler beim Speichern');
    $('#saveInfo').textContent = 'Gespeichert ✔︎';
    loadToday();
  };

  (async function boot(){
    if (!localStorage.getItem('token')) return;
    await loadShops();
    await loadToday();
  })();
</script>
</body>
</html>
