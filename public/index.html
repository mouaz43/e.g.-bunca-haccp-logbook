<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BUNCA HACCP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/style.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-dark brandbar">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#"><i class="bi bi-shield-check me-2"></i>BUNCA HACCP</a>
    <div class="d-flex gap-2 ms-auto">
      <select id="shopSelect" class="form-select form-select-sm"></select>
      <a id="adminBtn" href="/admin.html" class="btn btn-outline-light btn-sm">Admin</a>
      <button id="logoutBtn" class="btn btn-light btn-sm">Abmelden</button>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div id="statsRow" class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card card-shadow">
        <div class="card-body">
          <div class="text-secondary small">Checks (heute)</div>
          <div class="h3 mb-0"><span id="checksDone">0</span>/<span id="checksTotal">0</span></div>
          <div class="small text-secondary" id="lastSaved">—</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-shadow">
        <div class="card-body">
          <div class="text-secondary small">Abweichungen</div>
          <div class="h3 mb-0" id="deviations">0</div>
          <div class="small text-secondary">Grenzwerte beachten</div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-shadow">
        <div class="card-body">
          <div class="text-secondary small">Offene Issues (heute)</div>
          <div class="h3 mb-0" id="openIssues">0</div>
          <a class="small" href="/historie.html">Historie & Export</a>
        </div>
      </div>
    </div>
  </div>

  <div class="card card-shadow">
    <div class="card-body">
      <h5 class="mb-3">HACCP Tages-Checkliste <span id="today"></span></h5>

      <div id="itemsWrap" class="row g-3"></div>

      <div class="mt-4">
        <label class="form-label">Notizen / Issues</label>
        <textarea id="notes" class="form-control" rows="3" placeholder="z. B. Kühlschrank 2 schließt nicht richtig…"></textarea>
      </div>

      <div class="d-flex gap-2 mt-3">
        <button id="resetBtn" class="btn btn-outline-secondary">Zurücksetzen</button>
        <button id="saveBtn" class="btn btn-brand"><i class="bi bi-save"></i> Speichern</button>
      </div>
    </div>
  </div>
</main>

<script>
const $ = s => document.querySelector(s);
const todayStr = new Date().toISOString().slice(0,10);
$("#today").textContent = new Date().toLocaleDateString("de-DE");

function authHeaders(){
  const t = localStorage.getItem("token");
  return t ? { "Authorization":"Bearer "+t, "Content-Type":"application/json" } : { "Content-Type":"application/json" };
}
async function apiGet(url){
  const r = await fetch(url, { headers: authHeaders(), cache: "no-store" });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}

let SHOPS = [];
let CURRENT = null;

function renderShopSelect(){
  const sel = $("#shopSelect");
  sel.innerHTML = SHOPS.map((s,i)=>`<option value="${s.id}">${s.name||("Shop "+(i+1))}</option>`).join("");
  const wanted = localStorage.getItem("shopId");
  if (wanted && SHOPS.some(s=>s.id===wanted)) sel.value = wanted;
  sel.onchange = () => { localStorage.setItem("shopId", sel.value); pickShop(sel.value); };
}

function pickShop(id){
  CURRENT = SHOPS.find(s=>s.id===id) || SHOPS[0];
  renderItems();
}

function inputId(item){ return `item_${item.id}`; }

function renderItems(){
  const wrap = $("#itemsWrap");
  const items = CURRENT?.items || [];
  $("#checksTotal").textContent = items.length;

  wrap.innerHTML = items.map(it=>{
    if(it.type === "boolean"){
      return `
        <div class="col-md-6">
          <div class="form-check border rounded p-3">
            <input class="form-check-input" type="checkbox" id="${inputId(it)}">
            <label class="form-check-label fw-semibold" for="${inputId(it)}">${it.label}</label>
          </div>
        </div>
      `;
    }
    // number
    return `
      <div class="col-md-6">
        <label class="form-label fw-semibold">${it.label} ${rangeHint(it)}</label>
        <div class="input-group">
          <input type="number" step="0.1" class="form-control" id="${inputId(it)}" placeholder="z. B. 4.2">
          <span class="input-group-text">${it.unit || ""}</span>
        </div>
      </div>
    `;
  }).join("");
}

function rangeHint(it){
  if(it.rule === "range" && it.min != null && it.max != null) return `<span class="text-secondary small">( ${it.min} – ${it.max} ${it.unit || ""})</span>`;
  if(it.rule === "min"   && it.min != null) return `<span class="text-secondary small">(≥ ${it.min} ${it.unit || ""})</span>`;
  if(it.rule === "max"   && it.max != null) return `<span class="text-secondary small">(≤ ${it.max} ${it.unit || ""})</span>`;
  return "";
}

// Dummy save: you probably already had your own saving logic.
// The important part here is that the checklist renders from /api/shops.
$("#saveBtn").onclick = () => {
  // Example: count filled fields
  let done = 0;
  (CURRENT.items||[]).forEach(it=>{
    const el = $("#"+inputId(it));
    if(!el) return;
    if(it.type==="boolean" && el.checked) done++;
    if(it.type==="number" && el.value !== "") done++;
  });
  $("#checksDone").textContent = done;
  $("#lastSaved").textContent = new Date().toLocaleTimeString("de-DE");
  alert("Gespeichert (Demo). Hier bleibt dein vorhandener Save-Flow unverändert.");
};

$("#resetBtn").onclick = () => {
  (CURRENT.items||[]).forEach(it=>{
    const el = $("#"+inputId(it));
    if(!el) return;
    if(it.type==="boolean") el.checked = false;
    else el.value = "";
  });
  $("#checksDone").textContent = "0";
};

// logout/admin visibility
$("#logoutBtn").onclick = ()=>{ localStorage.removeItem("token"); localStorage.removeItem("role"); location.reload(); };
const role = localStorage.getItem("role");
$("#adminBtn").style.display = (role==="admin") ? "" : "none";

// boot
(async function(){
  SHOPS = await apiGet("/api/shops?t=" + Date.now()); // no cache
  renderShopSelect();
  pickShop($("#shopSelect").value);
})();
</script>
</body>
</html>
