<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BUNCA HACCP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{background:#f4f6f8}
    .brandbar{background:#1f7a3f}
    .card-shadow{box-shadow:0 10px 25px rgba(0,0,0,.06)}
    .login-card{max-width:480px}
    .metric{font-weight:700;font-size:28px}
    .warn{color:#d58512}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark brandbar">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#">BUNCA HACCP</a>
      <div class="d-flex gap-2">
        <select id="shopSelect" class="form-select form-select-sm"></select>
        <a id="cleanLink" class="btn btn-outline-light btn-sm d-none" href="/cleaning.html">Cleaning Plan</a>
        <a id="guideLink" class="btn btn-outline-light btn-sm" href="/guide.html">HACCP Guide</a>
        <a id="adminLink" class="btn btn-outline-light btn-sm d-none" href="/admin.html">Admin</a>
        <button id="btnLogout" class="btn btn-light btn-sm d-none">Abmelden</button>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <!-- Login -->
    <div id="loginBox" class="card card-shadow login-card mx-auto">
      <div class="card-body">
        <h3 class="h4 mb-3">Anmelden</h3>
        <div class="mb-2"><label class="form-label">E-Mail</label><input id="loginEmail" class="form-control" value=""></div>
        <div class="mb-3"><label class="form-label">Passwort</label><input id="loginPass" type="password" class="form-control"></div>
        <button id="btnLogin" class="btn btn-success">Login</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dash" class="d-none">
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="card card-shadow p-3"><div class="text-muted">Checks (heute)</div><div class="metric" id="checksCount">0/0</div><div class="small text-muted" id="lastSaved">–</div></div>
        </div>
        <div class="col-md-4">
          <div class="card card-shadow p-3"><div class="text-muted">Abweichungen</div><div class="metric warn" id="deviations">0</div><div class="small text-muted">Grenzwerte beachten</div></div>
        </div>
        <div class="col-md-4">
          <div class="card card-shadow p-3"><div class="text-muted">Offene Issues (heute)</div><div class="metric" id="issuesToday">0</div><a class="small" id="historyLink" href="/historie.html">Historie & Export</a></div>
        </div>
      </div>

      <div class="card card-shadow">
        <div class="card-body">
          <h5 class="card-title">HACCP Tages-Checkliste <span id="todaySpan"></span></h5>
          <div id="itemsGrid" class="row g-3"></div>
          <div class="mt-3">
            <label class="form-label">Notizen / Issues</label>
            <textarea id="notes" class="form-control" rows="3" placeholder="z. B. Kühlschrank 2 schließt nicht richtig…"></textarea>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button id="btnReset" class="btn btn-outline-secondary">Zurücksetzen</button>
            <button id="btnSave" class="btn btn-success">Speichern</button>
            <div class="ms-auto small text-muted align-self-center" id="saveInfo">–</div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = s => document.querySelector(s);
  const token = localStorage.getItem('token');
  const role  = localStorage.getItem('role');

  function setAuthUI() {
    const logged = !!token;
    $('#loginBox').classList.toggle('d-none', logged);
    $('#dash').classList.toggle('d-none', !logged);
    $('#btnLogout').classList.toggle('d-none', !logged);
    $('#adminLink').classList.toggle('d-none', !(role === 'admin'));
    $('#cleanLink').classList.toggle('d-none', !logged);
  }
  setAuthUI();

  $('#btnLogin').onclick = async () => {
    const email = $('#loginEmail').value.trim();
    const password = $('#loginPass').value;
    const r = await fetch('/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
    const data = await r.json();
    if (!r.ok) return alert(data.error || 'Login fehlgeschlagen');
    localStorage.setItem('token', data.token);
    localStorage.setItem('role', data.role || 'staff');
    location.reload();
  };
  $('#btnLogout').onclick = () => { localStorage.removeItem('token'); localStorage.removeItem('role'); location.reload(); };

  async function authFetch(url, opts={}) {
    const h = opts.headers || {};
    h['Authorization'] = 'Bearer ' + localStorage.getItem('token');
    if (!h['Content-Type'] && opts.method && opts.method !== 'GET') h['Content-Type'] = 'application/json';
    const r = await fetch(url, { ...opts, headers: h });
    if (r.status === 401) { alert('Bitte neu anmelden.'); location.reload(); }
    return r;
  }

  async function loadShops() {
    const r = await authFetch('/api/shops'); const shops = await r.json();
    $('#shopSelect').innerHTML = shops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  }

  function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  let _items = []; // shop checkItems
  function renderItems(values) {
    $('#itemsGrid').innerHTML = _items.map(i => {
      if (i.type === 'boolean') {
        return `<div class="col-md-4"><div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="it-${i.id}" ${values[i.id] ? 'checked':''}>
          <label class="form-check-label" for="it-${i.id}">${i.label}</label>
        </div></div>`;
      } else {
        const placeholder = i.rule==='range' ? `z. B. ${i.min.toFixed?.(1)||i.min}–${i.max.toFixed?.(1)||i.max}` : (i.rule==='max' ? i.max : i.min);
        return `<div class="col-md-3">
          <label class="form-label">${i.label} ${i.note?`(${i.note})`:''}</label>
          <div class="input-group">
            <input id="it-${i.id}" type="number" step="0.1" class="form-control" placeholder="${placeholder}" value="${values[i.id] ?? ''}">
            <span class="input-group-text">${i.unit||''}</span>
          </div>
        </div>`;
      }
    }).join('');
  }

  function computeCounts(values){
    let total = _items.length, done = 0, dev = 0;
    for (const i of _items) {
      const v = values[i.id];
      if (i.type === 'boolean') { if (v) done++; continue; }
      if (v !== null && v !== '' && !Number.isNaN(Number(v))) {
        done++;
        const n = Number(v);
        if (i.rule==='range' && (n < i.min || n > i.max)) dev++;
        if (i.rule==='max'   && (n > i.max)) dev++;
        if (i.rule==='min'   && (n < i.min)) dev++;
      }
    }
    return {total, done, dev};
  }

  async function loadToday() {
    const shopId = $('#shopSelect').value || 'shop_default';
    const r = await authFetch(`/api/today?shopId=${encodeURIComponent(shopId)}`);
    const d = await r.json();

    _items = d.items || [];
    $('#todaySpan').textContent = d.date;
    renderItems(d.values || {});
    $('#notes').value = d.notes || '';
    $('#lastSaved').textContent = d.lastSavedAt ? new Date(d.lastSavedAt).toLocaleString() : '–';
    $('#issuesToday').textContent = (d.issues||[]).length;

    const cc = computeCounts(d.values || {});
    $('#checksCount').textContent = `${cc.done}/${cc.total}`;
    $('#deviations').textContent = cc.dev;
  }

  $('#shopSelect').onchange = loadToday;
  $('#btnReset').onclick = loadToday;

  $('#btnSave').onclick = async () => {
    const shopId = $('#shopSelect').value || 'shop_default';
    const values = {};
    for (const i of _items) {
      if (i.type === 'boolean') values[i.id] = !!document.getElementById('it-'+i.id).checked;
      else {
        const raw = document.getElementById('it-'+i.id).value;
        values[i.id] = raw === '' ? null : Number(raw);
      }
    }
    const body = { date: todayStr(), shopId, values, notes: $('#notes').value.trim(), issues: ($('#notes').value.trim()? [$('#notes').value.trim()]:[]) };
    const r = await authFetch('/api/today', { method:'POST', body: JSON.stringify(body) });
    const data = await r.json();
    if (!r.ok) return alert(data.error||'Fehler beim Speichern');
    $('#saveInfo').textContent = 'Gespeichert ✔︎';
    loadToday();
  };

  (async function boot(){
    if (!localStorage.getItem('token')) return;
    await loadShops(); await loadToday();
  })();
</script>
</body>
</html>
