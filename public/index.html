<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BUNCA HACCP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/style.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-dark brandbar">
    <div class="container">
      <a class="navbar-brand fw-bold" href="#"><i class="bi bi-shield-check me-2"></i>BUNCA HACCP</a>
      <div class="d-flex gap-2 align-items-center">
        <select id="shopSelect" class="form-select form-select-sm"></select>
        <a id="cleanLink" class="btn btn-outline-light btn-sm d-none" href="/cleaning.html"><i class="bi bi-broom"></i> Cleaning</a>
        <a id="guideLink" class="btn btn-outline-light btn-sm" href="/guide.html"><i class="bi bi-journal-text"></i> Guide</a>
        <a id="adminLink" class="btn btn-outline-light btn-sm d-none" href="/admin.html"><i class="bi bi-gear"></i> Admin</a>

        <div class="form-check form-switch text-white ms-2">
          <input class="form-check-input" type="checkbox" id="darkToggle">
          <label class="form-check-label small" for="darkToggle">Dark</label>
        </div>

        <button id="btnLogout" class="btn btn-light btn-sm d-none">Abmelden</button>
      </div>
    </div>
  </nav>

  <div class="container my-4">
    <!-- Login -->
    <div id="loginBox" class="card card-shadow login-card mx-auto">
      <div class="card-body">
        <h3 class="h4 mb-3">Anmelden</h3>
        <div class="mb-2"><label class="form-label">E-Mail</label><input id="loginEmail" class="form-control" value=""></div>
        <div class="mb-3"><label class="form-label">Passwort</label><input id="loginPass" type="password" class="form-control"></div>
        <button id="btnLogin" class="btn btn-brand">Login</button>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dash" class="d-none">
      <div class="row g-3 mb-3">
        <div class="col-md-4">
          <div class="card card-shadow p-3 rounded-xl">
            <div class="text-muted">Checks (heute)</div>
            <div class="metric" id="checksCount">0/0</div>
            <div class="progress thin"><div id="checksBar" class="progress-bar bg-success" style="width:0%"></div></div>
            <div class="small mt-1 smallmuted" id="lastSaved">–</div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-shadow p-3 rounded-xl">
            <div class="text-muted">Abweichungen</div>
            <div class="metric" id="deviations">0</div>
            <span id="devBadge" class="badge badge-dot ok">Alles im grünen Bereich</span>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card card-shadow p-3 rounded-xl">
            <div class="text-muted">Offene Issues (heute)</div>
            <div class="metric" id="issuesToday">0</div>
            <a class="small" id="historyLink" href="/historie.html"><i class="bi bi-clock-history"></i> Historie & Export</a>
          </div>
        </div>
      </div>

      <div class="card card-shadow rounded-xl overflow-hidden">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2">
            <i class="bi bi-clipboard2-check"></i>
            HACCP Tages-Checkliste <span id="todaySpan"></span>
          </h5>

          <div id="itemsGrid" class="row g-3 mt-2"></div>

          <div class="mt-3">
            <label class="form-label">Notizen / Issues</label>
            <textarea id="notes" class="form-control" rows="3" placeholder="z. B. Kühlschrank 2 schließt nicht richtig…"></textarea>
          </div>
        </div>

        <div class="p-3 sticky-actions d-flex align-items-center gap-2">
          <button id="btnReset" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise"></i> Zurücksetzen</button>
          <button id="btnSave" class="btn btn-brand"><i class="bi bi-save"></i> Speichern</button>
          <div class="ms-auto small smallmuted" id="saveInfo">–</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
    <div id="toastSaved" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body"><i class="bi bi-check2-circle me-2"></i>Gespeichert.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const $ = s => document.querySelector(s);
  const token = localStorage.getItem('token');
  const role  = localStorage.getItem('role');

  // Dark mode
  const root = document.documentElement;
  const darkPref = localStorage.getItem('bunca.dark') === '1';
  if (darkPref) root.classList.add('dark');
  $('#darkToggle').checked = darkPref;
  $('#darkToggle').onchange = () => {
    root.classList.toggle('dark', $('#darkToggle').checked);
    localStorage.setItem('bunca.dark', $('#darkToggle').checked ? '1' : '0');
  };

  function setAuthUI() {
    const logged = !!token;
    $('#loginBox').classList.toggle('d-none', logged);
    $('#dash').classList.toggle('d-none', !logged);
    $('#btnLogout').classList.toggle('d-none', !logged);
    $('#adminLink').classList.toggle('d-none', !(role === 'admin'));
    $('#cleanLink').classList.toggle('d-none', !logged);
  }
  setAuthUI();

  $('#btnLogin').onclick = async () => {
    const email = $('#loginEmail').value.trim();
    const password = $('#loginPass').value;
    const r = await fetch('/api/auth/login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
    const data = await r.json();
    if (!r.ok) return alert(data.error || 'Login fehlgeschlagen');
    localStorage.setItem('token', data.token);
    localStorage.setItem('role', data.role || 'staff');
    location.reload();
  };
  $('#btnLogout').onclick = () => { localStorage.removeItem('token'); localStorage.removeItem('role'); location.reload(); };

  async function authFetch(url, opts={}) {
    const h = opts.headers || {};
    h['Authorization'] = 'Bearer ' + localStorage.getItem('token');
    if (!h['Content-Type'] && opts.method && opts.method !== 'GET') h['Content-Type'] = 'application/json';
    const r = await fetch(url, { ...opts, headers: h });
    if (r.status === 401) { alert('Bitte neu anmelden.'); location.reload(); }
    return r;
  }

  async function loadShops() {
    const r = await authFetch('/api/shops'); const shops = await r.json();
    $('#shopSelect').innerHTML = shops.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
  }

  function todayStr(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

  let _items = [];       // definition from shop
  let _values = {};      // current values
  let _dirty  = false;

  function ruleHint(i){
    if (i.type==='boolean') return '';
    if (i.rule==='range') return `<div class="rule-hint">Soll: ${i.min}–${i.max} ${i.unit||''}</div>`;
    if (i.rule==='max')   return `<div class="rule-hint">Max: ${i.max} ${i.unit||''}</div>`;
    if (i.rule==='min')   return `<div class="rule-hint">Min: ${i.min} ${i.unit||''}</div>`;
    return '';
  }
  function iconFor(i){
    const map = { fridge1:'thermometer-snow', fridge2:'thermometer-snow', freezer:'snow', oven:'fire', dw82:'droplet', handwash:'hand-index-thumb', cleaningDone:'check2-circle' };
    return `<i class="bi bi-${map[i.id]||'toggles2'} me-1"></i>`;
  }
  function renderItems(values) {
    _values = {...values};
    $('#itemsGrid').innerHTML = _items.map(i => {
      if (i.type === 'boolean') {
        return `<div class="col-md-4">
          <label class="form-check mt-4">
            <input class="form-check-input" type="checkbox" id="it-${i.id}" ${values[i.id] ? 'checked':''}>
            <span class="form-check-label">${iconFor(i)}${i.label}</span>
          </label>
        </div>`;
      } else {
        const placeholder = i.rule==='range' ? `${i.min}–${i.max}` : (i.rule==='max' ? `≤ ${i.max}` : `≥ ${i.min}`);
        return `<div class="col-md-3">
          <label class="form-label">${iconFor(i)}${i.label}</label>
          <div class="input-group">
            <input id="it-${i.id}" type="number" step="0.1" class="form-control" placeholder="${placeholder}" value="${values[i.id] ?? ''}">
            <span class="input-group-text">${i.unit||''}</span>
          </div>
          ${ruleHint(i)}
        </div>`;
      }
    }).join('');
    // attach listeners
    for (const i of _items) {
      const el = document.getElementById('it-'+i.id);
      el.oninput = () => { _dirty = true; applyValidation(i, el); updateCounts(); };
      if (i.type==='number') applyValidation(i, el);
      if (i.type==='boolean') el.onchange = () => { _dirty=true; updateCounts(); };
    }
    $('#notes').oninput = () => { _dirty = true; };
    updateCounts();
  }

  function applyValidation(i, el){
    if (i.type!=='number') return;
    el.classList.remove('input-valid','input-warn','input-bad');
    const raw = el.value;
    if (raw==='' || Number.isNaN(Number(raw))) return;
    const v = Number(raw);
    const near = (a,b,x)=>Math.abs(x-a)<=0.5 || Math.abs(x-b)<=0.5; // 0.5° buffer
    let state='ok';
    if (i.rule==='range'){
      if (v<i.min || v>i.max) state='bad';
      else if (near(i.min,i.max,v)) state='warn';
    } else if (i.rule==='max'){
      if (v>i.max) state='bad';
      else if (near(-Infinity,i.max,v)) state='warn';
    } else if (i.rule==='min'){
      if (v<i.min) state='bad';
      else if (near(i.min,Infinity,v)) state='warn';
    }
    el.classList.add(state==='ok'?'input-valid':state==='warn'?'input-warn':'input-bad');
  }

  function computeCounts(values){
    let total = _items.length, done = 0, dev = 0;
    for (const i of _items) {
      const el = document.getElementById('it-'+i.id);
      if (i.type==='boolean'){ if (el.checked) done++; continue; }
      const raw = el.value;
      if (raw!=='' && !Number.isNaN(Number(raw))){
        done++;
        const n = Number(raw);
        if (i.rule==='range' && (n < i.min || n > i.max)) dev++;
        if (i.rule==='max'   && (n > i.max)) dev++;
        if (i.rule==='min'   && (n < i.min)) dev++;
      }
    }
    return {total, done, dev};
  }
  function updateCounts(){
    const c = computeCounts(_values);
    $('#checksCount').textContent = `${c.done}/${c.total}`;
    $('#checksBar').style.width = (c.total? (100*c.done/c.total) : 0) + '%';
    $('#deviations').textContent = c.dev;
    const badge = $('#devBadge');
    badge.className = 'badge badge-dot ' + (c.dev===0?'ok':c.dev<=2?'warn':'bad');
    badge.textContent = c.dev===0 ? 'Alles im grünen Bereich' : (c.dev<=2 ? 'Bitte prüfen' : 'Sofort handeln');
    $('#saveInfo').textContent = _dirty ? 'Nicht gespeichert' : '–';
  }

  async function loadToday() {
    const shopId = $('#shopSelect').value || 'shop_default';
    const r = await authFetch(`/api/today?shopId=${encodeURIComponent(shopId)}`);
    const d = await r.json();
    _items = d.items || [];
    $('#todaySpan').textContent = d.date;
    renderItems(d.values || {});
    $('#notes').value = d.notes || '';
    $('#lastSaved').textContent = d.lastSavedAt ? new Date(d.lastSavedAt).toLocaleString() : '–';
    $('#issuesToday').textContent = (d.issues||[]).length;
    _dirty = false; updateCounts();
  }

  $('#shopSelect').onchange = loadToday;
  $('#btnReset').onclick = loadToday;

  $('#btnSave').onclick = async () => {
    const shopId = $('#shopSelect').value || 'shop_default';
    const values = {};
    for (const i of _items) {
      const el = document.getElementById('it-'+i.id);
      values[i.id] = i.type==='boolean' ? !!el.checked : (el.value===''? null : Number(el.value));
    }
    const body = { date: todayStr(), shopId, values, notes: $('#notes').value.trim(), issues: ($('#notes').value.trim()? [$('#notes').value.trim()]:[]) };
    const r = await authFetch('/api/today', { method:'POST', body: JSON.stringify(body) });
    const data = await r.json();
    if (!r.ok) return alert(data.error||'Fehler beim Speichern');
    _dirty = false; $('#saveInfo').textContent = 'Gespeichert ✔︎'; $('#lastSaved').textContent = new Date().toLocaleString();
    new bootstrap.Toast($('#toastSaved')).show();
    updateCounts();
  };

  (async function boot(){
    if (!localStorage.getItem('token')) return;
    await loadShops(); await loadToday();
  })();
</script>
</body>
</html>
