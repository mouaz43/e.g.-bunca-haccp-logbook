<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BUNCA · Anmelden</title>
  <meta name="color-scheme" content="light only" />
  <style>
    :root{
      --green:#1f7a3a; --green-700:#0f4922; --ring:#b3e6c5;
      --bg:#f7faf7; --card:#ffffff; --border:#e5e7eb; --muted:#6b7280; --text:#0f172a;
      --shadow:0 10px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--text);
      background:linear-gradient(160deg,#f2fbf5 0%,#ffffff 45%,#f2fbf5 100%);
    }
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .card{
      width:100%;max-width:420px;background:var(--card);border:1px solid var(--border);
      border-radius:18px;box-shadow:var(--shadow);padding:22px
    }
    .brand{display:flex;align-items:center;gap:10px;margin-bottom:10px}
    .brand img{height:28px;width:auto}
    h1{font-size:20px;margin:8px 0 16px 0}
    .muted{color:var(--muted);font-size:13px}
    label{font-size:12px;font-weight:800;margin:12px 0 6px 0;display:block}
    input{
      width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:15px;outline:none;
      background:#fff;
    }
    input:focus{border-color:var(--green);box-shadow:0 0 0 4px var(--ring)}
    .row{display:flex;align-items:center;justify-content:space-between;margin-top:10px}
    .checkbox{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .btn{
      width:100%;margin-top:16px;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 14px;border-radius:12px;border:1px solid transparent;font-weight:800;cursor:pointer;
      background:var(--green);color:#fff;
    }
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .error{margin-top:12px;background:#fef2f2;color:#7f1d1d;border:1px solid #fecaca;border-radius:12px;padding:10px;font-size:13px}
    .footer{margin-top:18px;text-align:center;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="form" aria-labelledby="login-title">
      <div class="brand">
        <img src="assets/img/bunca-logo.svg" alt="BUNCA" onerror="this.remove()" />
        <strong>BUNCA HACCP</strong>
      </div>
      <h1 id="login-title">Anmelden</h1>
      <p class="muted">Bitte melden Sie sich an, um auf die BUNCA HACCP-Tools zuzugreifen.</p>

      <form id="loginForm" novalidate>
        <label for="email">E-Mail</label>
        <input id="email" name="email" type="email" autocomplete="username" required />

        <label for="password">Passwort</label>
        <input id="password" name="password" type="password" autocomplete="current-password" required />

        <div class="row">
          <label class="checkbox">
            <input id="remember" type="checkbox" />
            <span>Eingeloggt bleiben</span>
          </label>
          <a href="#" class="muted" id="forgot">Passwort vergessen?</a>
        </div>

        <button class="btn" id="submitBtn" type="submit">Anmelden</button>
        <div id="error" class="error" style="display:none"></div>
      </form>

      <div class="footer">© BUNCA · HACCP</div>
    </div>
  </div>

  <script>
  // If already logged in, go to start
  (function(){
    const token = localStorage.getItem('bunca_token');
    if (token) { window.location.replace('index.html'); }
  })();

  const form = document.getElementById('loginForm');
  const errorBox = document.getElementById('error');
  const submitBtn = document.getElementById('submitBtn');

  async function apiLogin(payload){
    // Try two common endpoints to stay compatible with your server
    const endpoints = ['/api/login','/api/auth/login'];
    let lastErr;
    for (const url of endpoints){
      try{
        const res = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if (!res.ok){
          lastErr = await res.text();
          continue;
        }
        return await res.json(); // expected: { token, user:{name,role,...} }
      }catch(e){ lastErr = e.message; }
    }
    throw new Error(lastErr || 'Login fehlgeschlagen');
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    errorBox.style.display = 'none';
    submitBtn.disabled = true;

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!email || !password){
      errorBox.textContent = 'Bitte E-Mail und Passwort eingeben.';
      errorBox.style.display = 'block';
      submitBtn.disabled = false;
      return;
    }

    try{
      const data = await apiLogin({ email, password });
      // Expect token + optional user payload from server
      if (!data || !data.token){
        throw new Error('Unerwartete Server-Antwort.');
      }
      localStorage.setItem('bunca_token', data.token);
      if (data.user) localStorage.setItem('bunca_user', JSON.stringify(data.user));
      // Persist longer if "remember" checked (extend by re-saving later in app if you want)
      if (document.getElementById('remember').checked){
        localStorage.setItem('bunca_remember', '1');
      } else {
        localStorage.removeItem('bunca_remember');
      }
      window.location.replace('index.html');
    }catch(err){
      errorBox.textContent = (''+err.message || 'Login fehlgeschlagen');
      errorBox.style.display = 'block';
    }finally{
      submitBtn.disabled = false;
    }
  });

  document.getElementById('forgot').addEventListener('click', (e)=>{
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    alert('Bitte wende dich an die Verwaltung, um das Passwort zurückzusetzen.' + (email ? `\nE-Mail: ${email}` : ''));
  });
  </script>
</body>
</html>
