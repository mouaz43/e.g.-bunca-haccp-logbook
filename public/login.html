<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BUNCA HACCP ¬∑ Anmeldung</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <meta name="theme-color" content="#10b981"/>
  <style>
    .login-wrap{max-width:520px;margin:18px auto}
    .tips{margin-top:10px}
    .tips li{color:var(--muted)}
  </style>
</head>
<body>
<header class="header">
  <div class="wrap">
    <div class="brand"><span class="dot"></span><span>BUNCA HACCP</span></div>
    <button id="menuToggle" class="menu-btn" aria-label="Men√º"><span></span></button>
    <nav id="mainNav" class="nav">
      <a href="/">Startseite</a>
      <a href="/dashboard">Dashboard</a>
      <a href="/admin">Verwaltung</a>
      <a class="active" href="/login">Anmelden</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="hero">
    <h1>Sichere Anmeldung</h1>
    <p class="muted">Admins legen Konten f√ºr Mitarbeitende an. Bitte BUNCA-Zugangsdaten verwenden.</p>
  </section>

  <form id="loginForm" class="card login-wrap" novalidate>
    <h3 class="card-title">Login</h3>
    <div class="row">
      <label>E-Mail</label>
      <input class="input" name="email" type="email" placeholder="du@bunca.de" required autocomplete="username">
    </div>
    <div class="row">
      <label>Passwort</label>
      <input class="input" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
    </div>
    <div class="row cols-2" style="align-items:center">
      <button class="btn primary" type="submit">Anmelden</button>
      <a class="btn" href="/">Abbrechen</a>
    </div>
    <p id="loginMsg" class="muted"></p>
    <ul class="tips">
      <li>Falls Admin-Login nicht klappt, <em>ADMIN_EMAIL</em> in Render pr√ºfen.</li>
      <li>Nach dem Login kannst du Benutzer & Filialen in der <a href="/admin">Verwaltung</a> pflegen.</li>
    </ul>
  </form>
</main>

<button id="fab" class="fab">‚â°</button>
<div id="fabMenu" class="fab-menu">
  <a href="/">üè† Startseite</a>
  <a href="/dashboard">üìä Dashboard</a>
  <a href="/admin">üõ† Verwaltung</a>
</div>

<footer>¬© BUNCA HACCP</footer>

<script src="/assets/helpers.js"></script>
<script>
  const form = document.getElementById('loginForm');
  const msg  = document.getElementById('loginMsg');

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = 'Pr√ºfe Zugang‚Ä¶';
    const email = form.email.value.trim();
    const password = form.password.value;
    if(!email || !password){
      msg.textContent = 'E-Mail und Passwort sind erforderlich.';
      Bunca.toast('Bitte beide Felder ausf√ºllen','warn');
      return;
    }
    try{
      const res = await fetch('/api/auth/login',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({email,password})
      });
      const out = await res.json();
      if(out.ok){
        sessionStorage.setItem('csrf', out.csrf);
        Bunca.toast('Willkommen!');
        if(out.role === 'admin')      location.href = '/admin';
        else if(out.role === 'auditor') location.href = '/dashboard';
        else                           location.href = '/';
      }else{
        msg.textContent = 'Anmeldung fehlgeschlagen';
        Bunca.toast('Ung√ºltige Zugangsdaten','err');
      }
    }catch(err){
      console.error(err);
      msg.textContent = 'Netzwerkfehler';
      Bunca.toast('Netzwerkfehler','err');
    }
  });
</script>
</body>
</html>
