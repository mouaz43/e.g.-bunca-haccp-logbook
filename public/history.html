<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BUNCA HACCP Â· Verlauf</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <meta name="theme-color" content="#10b981"/>
</head>
<body>
<header class="header">
  <div class="wrap">
    <div class="brand"><span class="dot"></span><span>BUNCA HACCP</span></div>
    <button id="menuToggle" class="menu-btn" aria-label="MenÃ¼"><span></span></button>
    <nav id="mainNav" class="nav">
      <a id="navBack" href="/">ZurÃ¼ck</a>
      <a href="/admin">Verwaltung</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="hero">
    <h1>Tageschecks â€” Verlauf</h1>
    <div class="grid cols-3">
      <div><label>Von</label><input id="from" type="date" class="input"></div>
      <div><label>Bis</label><input id="to" type="date" class="input"></div>
      <div><label>Status</label>
        <select id="status" class="input">
          <option value="">Alle</option>
          <option value="draft">Entwurf</option>
          <option value="submitted">Abgesendet</option>
          <option value="signed">Unterschrieben</option>
          <option value="closed">Geschlossen</option>
        </select>
      </div>
      <div><label>Schicht</label>
        <select id="shift" class="input">
          <option value="">Alle</option>
          <option value="morning">FrÃ¼h</option>
          <option value="mid">Mitte</option>
          <option value="closing">Schluss</option>
        </select>
      </div>
      <div><label>GerÃ¤t</label><select id="equipment" class="input"><option value="">Alle</option></select></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="filterBtn" class="btn">Filter anwenden</button>
      <a id="exportCsv" class="btn" href="#">CSV exportieren</a>
    </div>
  </section>

  <section class="card">
    <table class="table" id="runsTable">
      <thead><tr><th>Datum</th><th>Status</th><th>OK</th><th>Probleme</th><th>Notiz</th><th>Aktionen</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="card" id="details" style="display:none">
    <h3 class="card-title">Details</h3>
    <div id="detailsHead" class="row"></div>
    <hr>
    <div id="detailsBody" class="grid cols-2"></div>
    <hr>
    <div id="actionsWrap"></div>
  </section>
</main>

<button id="fab" class="fab">â‰¡</button>
<div id="fabMenu" class="fab-menu">
  <a id="fabBack" href="#">â¬… Zur Filiale</a>
  <a href="/admin">ðŸ›  Verwaltung</a>
</div>

<footer>Â© BUNCA HACCP</footer>

<script src="/assets/helpers.js"></script>
<script>
  function slug(){ const p=location.pathname.split('/'); return decodeURIComponent(p[p.length-1]); }
  function setDateInputsDefault(){
    const to = new Date();
    const from = new Date(Date.now() - 13*24*60*60*1000);
    byId('to').value = to.toISOString().slice(0,10);
    byId('from').value = from.toISOString().slice(0,10);
  }
  function byId(id){ return document.getElementById(id); }
  function qs(o){ return new URLSearchParams(Object.entries(o).filter(([,v])=> v!==undefined && v!==null && v!=='')).toString(); }
  function statusBadge(s){
    const cls = s==='signed' ? '' : (s==='submitted' ? 'warn' : (s==='draft' ? 'err' : ''));
    const map = {draft:'Entwurf', submitted:'Abgesendet', signed:'Unterschrieben', closed:'Geschlossen'};
    return `<span class="badge ${cls}">${map[s]||s}</span>`;
  }

  let EQUIP = [];
  let RUNS = [];

  function fillEquipmentSelect(){
    const sel = byId('equipment'); sel.innerHTML = '<option value="">Alle</option>';
    (EQUIP || []).forEach(e=>{
      const o = document.createElement('option');
      o.value = e.id; o.textContent = `${e.name}${e.type?` (${e.type})`:''}`;
      sel.appendChild(o);
    });
  }

  function renderRunsTable(rows){
    const tbody = byId('runsTable').querySelector('tbody');
    tbody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r.run_date}</td>
        <td>${statusBadge(r.status)}</td>
        <td>${r.ok_count||0}</td>
        <td>${r.fail_count||0}</td>
        <td>${(r.note||'').slice(0,80)}</td>
        <td>
          <button class="btn small" data-view="${r.id}">Anzeigen</button>
          <a class="btn small" target="_blank" href="/api/export/pdf?run_id=${encodeURIComponent(r.id)}">PDF</a>
        </td>
      </tr>
    `).join('') || '<tr><td colspan="6">Keine Daten fÃ¼r die gewÃ¤hlten Filter.</td></tr>';
  }

  function groupAnswersByEquip(answers){
    const g = new Map();
    answers.forEach(a=>{
      const key = a.equipment_id || 'general';
      if(!g.has(key)) g.set(key, []);
      g.get(key).push(a);
    });
    return g;
  }

  function renderDetails(data){
    const { run, answers, actions } = data;
    const head = byId('detailsHead');
    head.innerHTML = `
      <div><strong>Datum:</strong> ${run.run_date}</div>
      <div><strong>Status:</strong> ${statusBadge(run.status)}</div>
      <div><strong>Unterschrieben am:</strong> ${run.signed_at || 'â€”'}</div>
      <div style="grid-column:1/-1"><strong>Notiz:</strong> ${run.note || 'â€”'}</div>
      <div><a class="btn" target="_blank" href="/api/export/pdf?run_id=${encodeURIComponent(run.id)}">PDF Ã¶ffnen</a></div>
    `;

    const body = byId('detailsBody'); body.innerHTML = '';
    const groups = groupAnswersByEquip(answers || []);
    groups.forEach((list, key)=>{
      const sec = document.createElement('article');
      sec.className='card';
      const title = key==='general' ? 'Allgemein' : (list[0].equipment_name || 'GerÃ¤t');
      sec.innerHTML = `<h3 class="card-title">${title}</h3>` +
        list.map(a=>`
          <div class="row">
            <div><strong>${a.label}</strong> <span class="badge ${a.ok?'':'warn'}">${a.ok?'OK':'Problem'}</span></div>
            <div>${a.value}${a.kind==='temperature'?` ${a.unit||''}`:''}
              ${a.kind==='temperature'?(a.min!=null||a.max!=null?`<span class="badge">Ziel ${a.min??''}â€“${a.max??''} ${a.unit||''}</span>`:''):''}
              ${a.evidence_url?`<div class="muted">Beleg: <code>${a.evidence_url}</code></div>`:''}
            </div>
          </div>
        `).join('');
      body.appendChild(sec);
    });

    const actWrap = byId('actionsWrap');
    actWrap.innerHTML = `<h3 class="card-title">KorrekturmaÃŸnahmen</h3>` +
      ((actions||[]).length ? '' : '<p class="muted">Keine</p>');
    (actions||[]).forEach(ca=>{
      const row = document.createElement('div'); row.className='row';
      row.innerHTML = `
        <div><strong>${ca.description}</strong> <span class="badge ${ca.status==='done'?'':'warn'}">${ca.status==='done'?'erledigt':'offen'}</span></div>
        <div>ZustÃ¤ndig: ${ca.assigned_to || 'â€”'} Â· FÃ¤llig: ${ca.due_date || 'â€”'} ${ca.photo_url?`Â· <span class="muted">Foto: <code>${ca.photo_url}</code></span>`:''}</div>
      `;
      actWrap.appendChild(row);
    });

    byId('details').style.display='block';
    byId('details').scrollIntoView({ behavior: 'smooth' });
  }

  async function fetchRunsFiltered(){
    const shop = slug();
    const params = {
      shop,
      from: byId('from').value || '',
      to: byId('to').value || '',
      status: byId('status').value || '',
      equipment_id: byId('equipment').value || ''
    };
    const res = await fetch('/api/check-runs?'+qs(params));
    const data = await res.json();
    let rows = data.runs || [];

    const shift = byId('shift').value || '';
    if(shift){
      const keep = [];
      for(const r of rows){
        const det = await fetch('/api/check-runs/'+r.id).then(r=>r.json());
        const any = (det.answers||[]).some(a => (a.shift || 'morning') === shift);
        if(any) keep.push(r);
      }
      rows = keep;
    }

    RUNS = rows;
    renderRunsTable(RUNS);
  }

  async function fetchEquipment(){
    const data = await fetch('/api/equipment?shop='+encodeURIComponent(slug())).then(r=>r.json());
    EQUIP = data.equipment || [];
    fillEquipmentSelect();
  }

  function exportCsv(e){
    e.preventDefault();
    const params = {
      shop: slug(),
      from: byId('from').value || '',
      to: byId('to').value || '',
      status: byId('status').value || '',
      equipment_id: byId('equipment').value || ''
    };
    const url = '/api/export/csv?'+qs(params);
    window.open(url, '_blank');
  }

  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('[data-view]');
    if(btn){
      const id = btn.getAttribute('data-view');
      const data = await fetch('/api/check-runs/'+id).then(r=>r.json());
      if(!data.run){ Bunca.toast('Lauf nicht gefunden','err'); return; }
      renderDetails(data);
    }
  });

  (async function init(){
    const s = slug();
    byId('navBack').href = '/shop/'+encodeURIComponent(s);
    byId('fabBack').href = '/shop/'+encodeURIComponent(s);

    setDateInputsDefault();
    await fetchEquipment();
    await fetchRunsFiltered();

    byId('filterBtn').addEventListener('click', fetchRunsFiltered);
    byId('exportCsv').addEventListener('click', exportCsv);
  })();
</script>
</body>
</html>
