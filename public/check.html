<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BUNCA HACCP Â· Tagescheck</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <meta name="theme-color" content="#10b981"/>
</head>
<body>
<header class="header">
  <div class="wrap">
    <div class="brand"><span class="dot"></span><span>BUNCA HACCP</span></div>
    <button id="menuToggle" class="menu-btn" aria-label="MenÃ¼"><span></span></button>
    <nav id="mainNav" class="nav">
      <a id="navBack" href="/">ZurÃ¼ck</a>
      <a href="/admin">Verwaltung</a>
    </nav>
  </div>
</header>

<main class="container">
  <section class="hero">
    <h1>Tagescheck</h1>
    <div class="row cols-2">
      <div>
        <label>Schicht</label>
        <select id="shiftSel" class="input">
          <option value="morning">FrÃ¼h</option>
          <option value="mid">Mitte</option>
          <option value="closing">Schluss</option>
        </select>
      </div>
      <div>
        <label>Notizen (optional)</label>
        <input id="note" class="input" placeholder="Gibt es etwas zu melden?">
      </div>
    </div>
  </section>

  <div id="formWrap"></div>

  <section class="card" style="margin-top:12px">
    <div class="row cols-2">
      <button id="submitBtn" class="btn primary">Absenden</button>
      <div id="msg" class="muted"></div>
    </div>
  </section>
</main>

<button id="fab" class="fab">â‰¡</button>
<div id="fabMenu" class="fab-menu">
  <a id="fabBack" href="#">â¬… Zur Filiale</a>
  <a href="/admin">ðŸ›  Verwaltung</a>
</div>

<footer>Â© BUNCA HACCP</footer>

<script src="/assets/helpers.js"></script>
<script>
  function slug(){ const p=location.pathname.split('/'); return decodeURIComponent(p[p.length-1]); }
  function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
  function fmtTarget(i){ 
    const hasMin = (i.min!==null && i.min!==undefined && i.min!=='');
    const hasMax = (i.max!==null && i.max!==undefined && i.max!=='');
    if(!hasMin && !hasMax) return '';
    const u = i.unit || (i.kind==='temperature' ? 'Â°C' : '');
    return `${hasMin?i.min:''}${hasMin||hasMax?'â€“':''}${hasMax?i.max:''} ${u}`.trim();
  }
  function computeOk(i, val){
    if(i.kind==='boolean'){
      const v=String(val||'').toLowerCase();
      return (v==='true' || v==='yes' || v==='1' || v==='ja');
    }
    if(i.kind==='temperature' || i.kind==='number'){
      if(val==='' || val===null || val===undefined) return false;
      const n = Number(val);
      if(Number.isNaN(n)) return false;
      if(i.min!=null && n < Number(i.min)) return false;
      if(i.max!=null && n > Number(i.max)) return false;
      return true;
    }
    return String(val||'').trim().length>0;
  }
  function el(tag, attrs={}, html=''){
    const e=document.createElement(tag);
    Object.entries(attrs).forEach(([k,v])=> e.setAttribute(k, v));
    e.innerHTML = html;
    return e;
  }

  let ITEMS = [];
  let EQUIP_MAP = {};
  let CORR = {};
  let EVIDENCE = {};

  function groupByEquipment(items){
    const groups = new Map();
    items.forEach(i=>{
      const key = i.equipment_id || 'general';
      if(!groups.has(key)) groups.set(key, []);
      groups.get(key).push(i);
    });
    return groups;
  }

  function renderGroups(){
    const wrap = document.getElementById('formWrap');
    if(!ITEMS.length){
      wrap.innerHTML = `<section class="card"><h3 class="card-title">Keine Checkliste fÃ¼r diese Schicht</h3>
        <p class="muted">Admin in der Verwaltung um EintrÃ¤ge bitten.</p></section>`;
      return;
    }
    const groups = groupByEquipment(ITEMS);
    wrap.innerHTML = '';
    groups.forEach((list, key)=>{
      const title = key==='general' ? 'Allgemein' : (EQUIP_MAP[key] || 'GerÃ¤t');
      const sec = el('section', { class:'card' });
      sec.innerHTML = `<h3 class="card-title">${title}</h3>`;
      const grid = el('div', { class:'grid cols-2' });
      list.forEach(i => grid.appendChild(renderField(i)));
      sec.appendChild(grid);
      wrap.appendChild(sec);
    });
  }

  function renderField(i){
    const card = el('article', { class:'card', 'data-item-id': i.id, 'data-kind': i.kind, 'data-required': i.required ? '1' : '0', 'data-min': i.min ?? '', 'data-max': i.max ?? '', 'data-unit': i.unit || '' });
    const req = i.required ? ' <span class="badge err">Pflichtfeld</span>' : '';
    const target = i.kind==='temperature' || i.kind==='number' ? fmtTarget(i) : '';
    const hint = target ? `<span class="badge">${target}</span>` : '';
    const head = `<div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
      <label><strong>${i.label}</strong>${req}</label>
      <span id="st_${i.id}" class="badge">â€”</span>
    </div>`;

    let control = '';
    if(i.kind==='temperature'){
      control = `<input id="v_${i.id}" type="number" step="0.1" class="input" placeholder="${i.unit||'Â°C'}">`;
    } else if(i.kind==='boolean'){
      control = `<select id="v_${i.id}" class="input"><option value="">â€”</option><option value="yes">Ja</option><option value="no">Nein</option></select>`;
    } else if(i.kind==='number'){
      control = `<input id="v_${i.id}" type="number" step="1" class="input">`;
    } else {
      control = `<input id="v_${i.id}" class="input">`;
    }

    const corrBtn = `<div class="row" style="margin-top:6px"><button class="btn small" data-corr="${i.id}" style="display:none">KorrekturmaÃŸnahme hinzufÃ¼gen</button> ${hint}</div>`;
    card.innerHTML = `${head}<div class="row" style="margin-top:6px">${control}</div>${corrBtn}`;
    return card;
  }

  function updateStatus(i){
    const val = document.getElementById('v_'+i.id)?.value ?? '';
    const ok = computeOk(i, val);
    const s = document.getElementById('st_'+i.id);
    s.className = 'badge ' + (ok ? '' : 'warn');
    s.textContent = ok ? 'OK' : (val==='' && !i.required ? 'â€”' : 'Problem');
    const btn = document.querySelector(`[data-corr="${i.id}"]`);
    if(btn) btn.style.display = ok ? 'none' : 'inline-flex';
    return ok;
  }

  function attachListeners(){
    ITEMS.forEach(i=>{
      const input = document.getElementById('v_'+i.id);
      if(!input) return;
      input.addEventListener('input', ()=> updateStatus(i));
      input.addEventListener('change', ()=> updateStatus(i));
    });
    document.addEventListener('click', onClick);
  }

  function openCorrectiveModal(item){
    const offline = !navigator.onLine;
    const wrap = document.createElement('div');
    wrap.className='card';
    wrap.style.cssText='position:fixed;inset:0;max-width:620px;margin:auto;z-index:90;background:#fff;border:1px solid var(--line);padding:16px;border-radius:14px;box-shadow:var(--shadow)';
    wrap.innerHTML = `
      <h3 class="card-title">KorrekturmaÃŸnahme â€” ${item.label}</h3>
      <div class="row"><label>Beschreibung</label><textarea id="caDesc" rows="3" class="input" placeholder="Was wurde getan?"></textarea></div>
      <div class="row cols-2">
        <div><label>ZustÃ¤ndig (optional)</label><input id="caAssign" class="input" placeholder="Name oder E-Mail"></div>
        <div><label>FÃ¤llig bis (optional)</label><input id="caDue" type="date" class="input"></div>
      </div>
      <div class="row"><label>Foto (optional) ${offline?'<span class="badge warn">Offline: deaktiviert</span>':''}</label>
        <input id="caFile" type="file" accept="image/*" class="input" ${offline?'disabled':''}>
        <p class="muted" style="margin:6px 0 0">${offline?'Foto kann spÃ¤ter im Verlauf ergÃ¤nzt werden.':''}</p>
      </div>
      <div class="row cols-2" style="margin-top:10px">
        <button id="caSave" class="btn primary">Speichern</button>
        <button id="caCancel" class="btn">Abbrechen</button>
      </div>
    `;
    const overlay = document.createElement('div');
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:89';
    document.body.appendChild(overlay);
    document.body.appendChild(wrap);

    wrap.querySelector('#caCancel').onclick = ()=>{ document.body.removeChild(wrap); document.body.removeChild(overlay); };
    wrap.querySelector('#caSave').onclick = async ()=>{
      const desc = wrap.querySelector('#caDesc').value.trim();
      const assigned_to = wrap.querySelector('#caAssign').value.trim() || null;
      const due_date = wrap.querySelector('#caDue').value || null;
      if(!desc){ Bunca.toast('Bitte eine kurze Beschreibung eingeben','warn'); return; }

      let photo_url = null;
      const file = wrap.querySelector('#caFile').files[0];
      if(file && navigator.onLine){
        try{
          const sign = await Bunca.api('/api/uploads/sign','POST',{ type:file.type });
          if(sign.ok){
            await fetch(sign.url, { method:'PUT', headers:{'Content-Type':file.type}, body:file });
            photo_url = sign.key;
          }
        }catch(e){ console.error(e); Bunca.toast('Upload fehlgeschlagen (wird ohne Foto gespeichert)','warn'); }
      }else if(file && !navigator.onLine){
        Bunca.toast('Offline: Foto nicht angehÃ¤ngt','warn');
      }

      CORR[item.id] = { description: desc, assigned_to, due_date, photo_url };
      Bunca.toast('KorrekturmaÃŸnahme gespeichert');
      document.body.removeChild(wrap); document.body.removeChild(overlay);
    };
  }

  async function submitRun(){
    const s = slug();
    const note = document.getElementById('note').value;
    const answers = ITEMS.map(i=>{
      const v = document.getElementById('v_'+i.id)?.value ?? '';
      const entry = { item_id:i.id, value:v };
      if(CORR[i.id]) entry.corrective = { ...CORR[i.id] };
      if(EVIDENCE[i.id]) entry.evidence_url = EVIDENCE[i.id];
      return entry;
    });

    const missing = ITEMS.filter(i=> i.required && (String(document.getElementById('v_'+i.id)?.value ?? '').trim()===''));
    if(missing.length){
      missing.forEach(i=>{ document.getElementById('v_'+i.id).style.borderColor = 'var(--bad)'; });
      Bunca.toast(`Fehlende Pflichtfelder: ${missing.map(i=>i.label).join(', ')}`, 'err');
      document.getElementById('msg').textContent = 'Bitte alle Pflichtfelder ausfÃ¼llen.';
      return;
    }

    const failedNoCorr = ITEMS.filter(i=>{
      const v = document.getElementById('v_'+i.id)?.value ?? '';
      return !computeOk(i, v) && !CORR[i.id];
    });
    if(failedNoCorr.length){
      Bunca.toast('FÃ¼r Probleme KorrekturmaÃŸnahmen hinzufÃ¼gen','warn');
      document.getElementById('msg').textContent = 'Probleme vorhanden â€” bitte KorrekturmaÃŸnahmen anlegen.';
      const first = failedNoCorr[0];
      document.querySelector(`[data-corr="${first.id}"]`)?.scrollIntoView({behavior:'smooth', block:'center'});
      return;
    }

    const body = { shop_slug:s, answers, note, status:'submitted' };

    if(Bunca.enqueueIfOffline('/api/check-runs', 'POST', body)){
      document.getElementById('msg').textContent = 'Offline gespeichert â€” wird automatisch synchronisiert.';
      setTimeout(()=> location.href='/history/'+encodeURIComponent(s), 500);
      return;
    }

    const res = await fetch('/api/check-runs',{ method:'POST', headers:{'Content-Type':'application/json','x-csrf-token':Bunca.csrf()}, body:JSON.stringify(body) });
    const out = await res.json();
    if(out.ok){
      Bunca.toast('Checkliste gespeichert âœ“');
      document.getElementById('msg').textContent = 'Gespeichert âœ“';
      openSignModal(out.run_id);
    }else{
      Bunca.toast(out.error || 'Speichern fehlgeschlagen','err');
      document.getElementById('msg').textContent = out.error || 'Fehler';
    }
  }

  function openSignModal(runId){
    const wrap = document.createElement('div');
    wrap.className='card';
    wrap.style.cssText='position:fixed;inset:0;max-width:480px;margin:auto;z-index:90;background:#fff;border:1px solid var(--line);padding:16px;border-radius:14px;box-shadow:var(--shadow)';
    wrap.innerHTML = `
      <h3 class="card-title">Unterschreiben & sperren</h3>
      <p class="muted">Zum Unterschreiben Passwort eingeben.${!navigator.onLine?' <span class="badge warn">Online erforderlich</span>':''}</p>
      <div class="row"><label>Passwort</label><input id="signPass" type="password" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" ${!navigator.onLine?'disabled':''}></div>
      <div class="row cols-2" style="margin-top:10px">
        <button id="signNow" class="btn primary" ${!navigator.onLine?'disabled':''}>Jetzt unterschreiben</button>
        <button id="signLater" class="btn">SpÃ¤ter</button>
      </div>
    `;
    const overlay = document.createElement('div');
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:89';
    document.body.appendChild(overlay);
    document.body.appendChild(wrap);

    wrap.querySelector('#signLater').onclick = ()=>{
      document.body.removeChild(wrap); document.body.removeChild(overlay);
      location.href = '/history/'+encodeURIComponent(slug());
    };
    wrap.querySelector('#signNow').onclick = async ()=>{
      const password = wrap.querySelector('#signPass').value;
      const res = await fetch('/api/check-runs/'+runId+'/sign',{ method:'POST', headers:{'Content-Type':'application/json','x-csrf-token':Bunca.csrf()}, body:JSON.stringify({ password }) });
      const out = await res.json();
      if(out.ok){ Bunca.toast('Unterschrieben âœ“'); document.body.removeChild(wrap); document.body.removeChild(overlay); location.href='/history/'+encodeURIComponent(slug()); }
      else { Bunca.toast(out.error||'Unterschrift fehlgeschlagen','err'); }
    };
  }

  async function onClick(e){
    const btn = e.target.closest('[data-corr]');
    if(btn){
      const id = btn.getAttribute('data-corr');
      const item = ITEMS.find(x=>x.id===id);
      if(item) openCorrectiveModal(item);
    }
  }

  (async function init(){
    const session = await Bunca.requireSession(); if(!session) return;
    const s = slug();
    document.getElementById('navBack').href = '/shop/'+encodeURIComponent(s);
    document.getElementById('fabBack').href = '/shop/'+encodeURIComponent(s);

    const qShift = (qs('shift')||'').toLowerCase();
    const nowH = new Date().getHours();
    const guess = nowH < 12 ? 'morning' : (nowH < 18 ? 'mid' : 'closing');
    const shift = ['morning','mid','closing'].includes(qShift) ? qShift : guess;
    document.getElementById('shiftSel').value = shift;

    const eq = await (await fetch('/api/equipment?shop='+encodeURIComponent(s))).json();
    EQUIP_MAP = Object.fromEntries((eq.equipment||[]).map(e=>[e.id, e.name]));

    async function loadItemsForShift(sh){
      const list = await fetch('/api/check-items?shop='+encodeURIComponent(s)+'&shift='+encodeURIComponent(sh)).then(r=>r.json());
      ITEMS = (list.items||[]).sort((a,b)=> (a.position ?? 0) - (b.position ?? 0));
      renderGroups();
      attachListeners();
      ITEMS.forEach(updateStatus);
    }
    await loadItemsForShift(shift);

    document.getElementById('shiftSel').addEventListener('change', async (e)=>{
      CORR = {}; EVIDENCE = {};
      await loadItemsForShift(e.target.value);
    });

    document.getElementById('submitBtn').addEventListener('click', submitRun);
  })();
</script>
</body>
</html>
