<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BUNCA HACCP • Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/style.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-dark brandbar">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/index.html"><i class="bi bi-shield-check me-2"></i>BUNCA HACCP</a>
    <div class="ms-auto d-flex gap-2">
      <a class="btn btn-outline-light btn-sm" href="/index.html"><i class="bi bi-house"></i> Übersicht</a>
      <button id="btnLogout" class="btn btn-light btn-sm">Abmelden</button>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Adminbereich</h1>
    <button id="btnNewShop" class="btn btn-brand"><i class="bi bi-plus-lg"></i> Neuer Shop</button>
  </div>

  <div class="card card-shadow">
    <div class="table-responsive">
      <table class="table align-middle mb-0" id="shopsTable">
        <thead class="table-light"><tr>
          <th>Name</th><th>Stadt</th><th>Adresse</th><th>Aktiv</th><th class="text-end">Aktion</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<!-- Modal -->
<div class="modal fade" id="shopModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shopModalTitle">Shop bearbeiten</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
      </div>

      <div class="modal-body">
        <form id="shopForm" class="needs-validation" novalidate>
          <input type="hidden" id="shopId">

          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Name</label>
              <input id="shopName" class="form-control" required>
              <div class="invalid-feedback">Name erforderlich.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Stadt</label>
              <input id="shopCity" class="form-control">
            </div>
            <div class="col-md-4">
              <label class="form-label">Adresse</label>
              <input id="shopAddress" class="form-control">
            </div>
            <div class="col-12">
              <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" id="shopActive">
                <label class="form-check-label" for="shopActive">Aktiv</label>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-2">Checkliste (Items)</h6>
            <button id="btnAddItem" type="button" class="btn btn-sm btn-outline-secondary"><i class="bi bi-plus-lg"></i> Item</button>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="itemsTable">
              <thead class="table-light">
                <tr>
                  <th style="width:170px">ID</th>
                  <th>Label</th>
                  <th style="width:150px">Typ</th>
                  <th style="width:110px">Einheit</th>
                  <th style="width:130px">Regel</th>
                  <th style="width:110px">Min</th>
                  <th style="width:110px">Max</th>
                  <th class="text-end" style="width:70px">—</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <hr class="my-4">

          <div class="d-flex justify-content-between align-items-center">
            <h6 class="mb-2">Cleaning Plan</h6>
            <button id="btnAddTask" type="button" class="btn btn-sm btn-outline-secondary"><i class="bi bi-plus-lg"></i> Aufgabe</button>
          </div>
          <div class="table-responsive">
            <table class="table align-middle" id="tasksTable">
              <thead class="table-light">
                <tr>
                  <th style="width:170px">ID</th>
                  <th>Aufgabe</th>
                  <th style="width:160px">Frequenz</th>
                  <th style="width:200px">Bereich</th>
                  <th class="text-end" style="width:70px">—</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button id="btnSaveShop" type="button" class="btn btn-brand"><i class="bi bi-save"></i> Speichern</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ========= helpers ========= */
const $ = s => document.querySelector(s);
const rnd = (p='id') => p + '_' + Math.random().toString(36).slice(2,8);

function authHeaders(){
  const t = localStorage.getItem('token');
  if(!t){ alert('Bitte neu anmelden'); location.href='/index.html'; return; }
  return { 'Authorization':'Bearer '+t, 'Content-Type':'application/json' };
}
async function authFetch(url, opts={}){
  const headers = { ...(opts.headers||{}), ...authHeaders() };
  const r = await fetch(url, { ...opts, headers });
  if(r.status===401){ alert('Sitzung abgelaufen. Bitte anmelden.'); location.href='/index.html'; }
  return r;
}

/* ========= state ========= */
let SHOPS = [];         // full shop objects for editing
let editingShop = null; // object or null
const shopModal = new bootstrap.Modal('#shopModal');

/* ========= load & render ========= */
async function loadShops(){
  // Admin endpoint returns full objects incl. items & cleaningPlan
  const r = await authFetch('/api/admin/shops');
  const data = await r.json();
  if(!r.ok){ alert(data.error || 'Fehler beim Laden der Shops'); return; }
  SHOPS = data;
  renderList();
}

function renderList(){
  const tbody = $('#shopsTable tbody');
  tbody.innerHTML = SHOPS.map(s=>`
    <tr>
      <td class="fw-semibold">${s.name||'-'}</td>
      <td>${s.city||'-'}</td>
      <td>${s.address||'-'}</td>
      <td>${s.active?'<span class="badge text-bg-success">aktiv</span>':'<span class="badge text-bg-secondary">inaktiv</span>'}</td>
      <td class="text-end">
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-secondary" data-edit="${s.id}"><i class="bi bi-pencil-square"></i></button>
          <button class="btn btn-sm btn-outline-danger" data-del="${s.id}"><i class="bi bi-trash"></i></button>
        </div>
      </td>
    </tr>
  `).join('');

  tbody.querySelectorAll('[data-edit]').forEach(b=>{
    b.onclick = () => openEdit(b.dataset.edit);
  });
  tbody.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick = () => delShop(b.dataset.del);
  });
}

/* ========= modal edit/new ========= */
function emptyShop(){
  return {
    id: rnd('shop'),
    name: '',
    city: '',
    address: '',
    active: true,
    items: [],
    cleaningPlan: []
  };
}

function openEdit(id){
  editingShop = id ? SHOPS.find(s=>s.id===id) : emptyShop();

  $('#shopModalTitle').textContent = id ? 'Shop bearbeiten' : 'Neuer Shop';
  $('#shopId').value = editingShop.id;
  $('#shopName').value = editingShop.name || '';
  $('#shopCity').value = editingShop.city || '';
  $('#shopAddress').value = editingShop.address || '';
  $('#shopActive').checked = !!editingShop.active;

  // items
  const itBody = $('#itemsTable tbody');
  itBody.innerHTML = '';
  (editingShop.items||[]).forEach(addItemRow);
  if(!editingShop.items || editingShop.items.length===0) addItemRow();

  // tasks
  const tkBody = $('#tasksTable tbody');
  tkBody.innerHTML = '';
  (editingShop.cleaningPlan||[]).forEach(addTaskRow);
  if(!editingShop.cleaningPlan || editingShop.cleaningPlan.length===0) addTaskRow();

  shopModal.show();
}

function addItemRow(item){
  const row = document.createElement('tr');
  const it = item || { id: rnd('item'), label:'', type:'number', unit:'°C', rule:'range', min:0, max:10 };
  row.innerHTML = `
    <td><input class="form-control form-control-sm" data-field="id" value="${it.id}"></td>
    <td><input class="form-control form-control-sm" data-field="label" value="${it.label||''}" placeholder="Bezeichnung"></td>
    <td>
      <select class="form-select form-select-sm" data-field="type">
        <option value="number" ${it.type==='number'?'selected':''}>Zahl</option>
        <option value="boolean" ${it.type==='boolean'?'selected':''}>Ja/Nein</option>
      </select>
    </td>
    <td><input class="form-control form-control-sm" data-field="unit" value="${it.unit||''}" placeholder="z. B. °C"></td>
    <td>
      <select class="form-select form-select-sm" data-field="rule">
        <option value="range" ${it.rule==='range'?'selected':''}>↔︎ Bereich</option>
        <option value="max" ${it.rule==='max'?'selected':''}>≤ Max</option>
        <option value="min" ${it.rule==='min'?'selected':''}>≥ Min</option>
      </select>
    </td>
    <td><input type="number" step="0.1" class="form-control form-control-sm" data-field="min" value="${it.min ?? ''}"></td>
    <td><input type="number" step="0.1" class="form-control form-control-sm" data-field="max" value="${it.max ?? ''}"></td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" data-remove-row><i class="bi bi-x"></i></button></td>
  `;
  row.querySelector('[data-remove-row]').onclick = () => row.remove();
  // Disable unit/rule/min/max when boolean
  const typeSel = row.querySelector('[data-field="type"]');
  const toggleForType = () => {
    const on = typeSel.value==='number';
    row.querySelector('[data-field="unit"]').disabled = !on;
    row.querySelector('[data-field="rule"]').disabled = !on;
    row.querySelector('[data-field="min"]').disabled  = !on;
    row.querySelector('[data-field="max"]').disabled  = !on;
  };
  typeSel.onchange = toggleForType; toggleForType();
  $('#itemsTable tbody').appendChild(row);
}

function addTaskRow(task){
  const row = document.createElement('tr');
  const t = task || { id: rnd('task'), name:'', freq:'daily', area:'' };
  row.innerHTML = `
    <td><input class="form-control form-control-sm" data-field="id" value="${t.id}"></td>
    <td><input class="form-control form-control-sm" data-field="name" value="${t.name||''}" placeholder="Aufgabe"></td>
    <td>
      <select class="form-select form-select-sm" data-field="freq">
        <option value="daily" ${t.freq==='daily'?'selected':''}>täglich</option>
        <option value="weekly" ${t.freq==='weekly'?'selected':''}>wöchentlich</option>
        <option value="monthly" ${t.freq==='monthly'?'selected':''}>monatlich</option>
      </select>
    </td>
    <td><input class="form-control form-control-sm" data-field="area" value="${t.area||''}" placeholder="Bereich (z. B. Küche)"></td>
    <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger" data-remove-row><i class="bi bi-x"></i></button></td>
  `;
  row.querySelector('[data-remove-row]').onclick = () => row.remove();
  $('#tasksTable tbody').appendChild(row);
}

function collectRows(tbodySel){
  const rows = Array.from(document.querySelectorAll(`${tbodySel} tr`));
  return rows.map(tr=>{
    const obj = {};
    tr.querySelectorAll('[data-field]').forEach(inp=>{
      let val = inp.value;
      const name = inp.getAttribute('data-field');
      if (name==='min' || name==='max') val = (val===''? null : Number(val));
      obj[name] = val;
    });
    return obj;
  }).filter(x => (x.id && x.label!=='' ) || (tbodySel==='#tasksTable tbody' && x.id && x.name!==''));
}

/* ========= actions ========= */
$('#btnNewShop').onclick = () => openEdit(null);
$('#btnAddItem').onclick = () => addItemRow();
$('#btnAddTask').onclick = () => addTaskRow();

$('#btnSaveShop').onclick = async () => {
  // Validate basic fields
  const form = $('#shopForm');
  if(!form.checkValidity()){ form.classList.add('was-validated'); return; }

  const payload = {
    id: $('#shopId').value || rnd('shop'),
    name: $('#shopName').value.trim(),
    city: $('#shopCity').value.trim(),
    address: $('#shopAddress').value.trim(),
    active: $('#shopActive').checked,
    items: collectRows('#itemsTable tbody').map(i=>{
      if(i.type==='boolean'){ i.unit=''; i.rule=''; i.min=null; i.max=null; }
      else { if(!i.rule) i.rule='range'; }
      return i;
    }),
    cleaningPlan: collectRows('#tasksTable tbody')
  };

  const isEdit = SHOPS.some(s=>s.id===payload.id);
  const url = isEdit ? `/api/admin/shops/${encodeURIComponent(payload.id)}` : '/api/admin/shops';
  const method = isEdit ? 'PUT' : 'POST';

  const r = await authFetch(url, { method, body: JSON.stringify(payload) });
  const data = await r.json();
  if(!r.ok){ alert(data.error || 'Speichern fehlgeschlagen'); return; }

  await loadShops();
  shopModal.hide();
};

async function delShop(id){
  if(!confirm('Diesen Shop wirklich löschen?')) return;
  const r = await authFetch(`/api/admin/shops/${encodeURIComponent(id)}`, { method:'DELETE' });
  if(!r.ok){ const x = await r.json(); alert(x.error||'Löschen fehlgeschlagen'); return; }
  await loadShops();
}

/* ========= boot ========= */
$('#btnLogout').onclick = () => { localStorage.removeItem('token'); localStorage.removeItem('role'); location.href='/index.html'; };

(async function(){
  const role = localStorage.getItem('role');
  if(role!=='admin'){ alert('Nur für Admins.'); location.href='/index.html'; return; }
  await loadShops();
})();
</script>
</body>
</html>
