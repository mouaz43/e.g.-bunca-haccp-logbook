<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BUNCA HACCP ¬∑ Admin</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <meta name="theme-color" content="#10b981"/>
</head>
<body>
<header class="header">
  <div class="wrap">
    <div class="brand"><span class="dot"></span><span>BUNCA HACCP</span></div>
    <button id="menuToggle" class="menu-btn" aria-label="Menu"><span></span></button>
    <nav id="mainNav" class="nav">
      <a href="/">Home</a>
      <a class="active" href="/admin">Admin</a>
      <a href="/login">Login</a>
    </nav>
  </div>
</header>

<main class="container layout">
  <aside class="side">
    <h4>Admin</h4>
    <a href="#" data-tab="users" class="active">üë§ Users</a>
    <a href="#" data-tab="shops">üè¨ Shops</a>
    <a href="#" data-tab="checklist">‚úÖ Checklist</a>
    <hr>
    <a href="#" id="logoutLink">üö™ Logout</a>
  </aside>

  <section class="content">
    <!-- USERS -->
    <section class="section show" id="tab-users">
      <div class="card" style="max-width:760px">
        <h3 class="card-title">Create User</h3>
        <p class="muted">Admins can create accounts for staff.</p>
        <div class="row"><label>Email</label><input id="uEmail" class="input" type="email" placeholder="user@bunca.de"></div>
        <div class="row"><label>Password</label><input id="uPass" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
        <div class="row"><label>Role</label>
          <select id="uRole" class="input"><option value="user">User</option><option value="admin">Admin</option></select>
        </div>
        <div class="row cols-2">
          <button id="createUser" class="btn primary">Create</button>
          <div id="userMsg" class="muted"></div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 class="card-title">Users</h3>
        <table class="table" id="usersTbl">
          <thead><tr><th>Email</th><th>Role</th><th style="width:140px">Actions</th></tr></thead><tbody></tbody>
        </table>
      </div>
    </section>

    <!-- SHOPS -->
    <section class="section" id="tab-shops">
      <div class="grid cols-2">
        <div class="card">
          <h3 class="card-title">Create Shop</h3>
          <div class="row"><label>Name</label><input id="sName" class="input" placeholder="BUNCA City"></div>
          <div class="row"><label>Slug</label><input id="sSlug" class="input" placeholder="city"></div>
          <div class="row"><label>Address</label><input id="sAddress" class="input" placeholder="Street 1, Frankfurt"></div>
          <div class="row"><label>Phone</label><input id="sPhone" class="input" placeholder="+49 ..."></div>
          <div class="row"><label>Image URL</label><input id="sImg" class="input" placeholder="https://..."></div>
          <div class="row"><label>Description</label><textarea id="sDesc" rows="3" class="input" placeholder="Warm croissants, dialed-in espresso..."></textarea></div>
          <div class="row"><label>Status</label>
            <select id="sStatus" class="input"><option value="open">Open</option><option value="closed">Closed</option></select>
          </div>
          <div class="row cols-2">
            <button id="createShop" class="btn primary">Save</button>
            <div id="shopMsg" class="muted"></div>
          </div>
        </div>

        <div class="card">
          <h3 class="card-title">Shops</h3>
          <table class="table" id="shopsTbl">
            <thead><tr><th>Name</th><th>Slug</th><th>Status</th><th style="width:220px">Actions</th></tr></thead><tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CHECKLIST -->
    <section class="section" id="tab-checklist">
      <div class="card">
        <h3 class="card-title">Checklist Templates</h3>
        <p class="muted">Pick a shop and define daily checklist items (Fridge, Oven, Dishwasher ‚Ä¶). Use ‚ÄúPosition‚Äù to control order.</p>
        <div class="row cols-2">
          <div><label>Shop</label><select id="ciShop" class="input"></select></div>
          <div class="muted" style="display:flex;align-items:end">Position 0..n (sorts ascending)</div>
        </div>

        <div class="grid cols-3" style="margin-top:8px">
          <div class="row"><label>Label</label><input id="ciLabel" class="input" placeholder="Fridge 1"></div>
          <div class="row"><label>Kind</label>
            <select id="ciKind" class="input">
              <option value="temperature">Temperature</option>
              <option value="boolean">Yes / No</option>
              <option value="number">Number</option>
              <option value="text">Text</option>
            </select>
          </div>
          <div class="row"><label>Position</label><input id="ciPos" type="number" class="input" value="0"></div>
          <div class="row"><label>Min (¬∞C)</label><input id="ciMin" type="number" step="0.1" class="input"></div>
          <div class="row"><label>Max (¬∞C)</label><input id="ciMax" type="number" step="0.1" class="input"></div>
          <div class="row"><label>Unit</label><input id="ciUnit" class="input" value="¬∞C"></div>
        </div>

        <div class="row cols-2" style="margin-top:8px">
          <button id="ciAdd" class="btn primary">Add Item</button>
          <div id="ciMsg" class="muted"></div>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <table class="table" id="ciTable">
          <thead><tr><th>Pos</th><th>Label</th><th>Kind</th><th>Limits</th><th style="width:120px">Actions</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </section>
</main>

<button id="fab" class="fab">‚â°</button>
<div id="fabMenu" class="fab-menu">
  <a href="/">üè† Home</a>
  <a href="/admin">üõ† Admin</a>
  <a id="logoutFab" href="#">üö™ Logout</a>
</div>

<footer>¬© BUNCA HACCP</footer>

<script src="/assets/helpers.js"></script>
<script>
  // ---- Tabbed sidebar ----
  function showTab(name){
    document.querySelectorAll('.side a[data-tab]').forEach(a=>a.classList.toggle('active', a.dataset.tab===name));
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('show'));
    const active = document.getElementById('tab-'+name);
    if(active) active.classList.add('show');
  }
  document.addEventListener('click', (e)=>{
    const link = e.target.closest('.side a[data-tab]');
    if(link){ e.preventDefault(); showTab(link.dataset.tab); }
  });

  // ---- Admin logic ----
  (async function init(){
    const s = await Bunca.requireSession('admin'); if(!s) return;

    document.getElementById('logoutLink').addEventListener('click', logout);
    document.getElementById('logoutFab').addEventListener('click', logout);

    document.getElementById('createUser').addEventListener('click', createUser);
    document.getElementById('createShop').addEventListener('click', createShop);
    document.getElementById('ciAdd').addEventListener('click', addItem);
    document.getElementById('ciShop').addEventListener('change', e=>loadChecklist(e.target.value));
    document.addEventListener('click', onClickRow);

    await Promise.all([loadUsers(), loadShops()]);
  })();

  async function logout(e){
    e.preventDefault();
    await Bunca.api('/api/auth/logout','POST',{});
    sessionStorage.removeItem('csrf');
    location.href='/';
  }

  // Users
  async function loadUsers(){
    const data = await Bunca.api('/api/users');
    document.querySelector('#usersTbl tbody').innerHTML =
      (data.users||[]).map(u=>`
        <tr>
          <td>${u.email}</td><td>${u.role}</td>
          <td><button class="btn bad small" data-del-user="${u.id}">Delete</button></td>
        </tr>`).join('');
  }

  // Shops
  let shops=[];
  async function loadShops(){
    const res = await fetch('/api/shops'); const data = await res.json();
    shops = data.shops || [];
    document.querySelector('#shopsTbl tbody').innerHTML = shops.map(s=>`
      <tr>
        <td>${s.name}</td><td>${s.slug}</td>
        <td><span class="badge ${s.status==='open'?'':'warn'}">${s.status}</span></td>
        <td>
          <a class="btn small" href="/shop/${encodeURIComponent(s.slug)}">Open</a>
          <a class="btn small" href="/history/${encodeURIComponent(s.slug)}">History</a>
          <button class="btn bad small" data-del-shop="${s.id}">Delete</button>
        </td>
      </tr>`).join('');
    const sel = document.getElementById('ciShop');
    sel.innerHTML = shops.map(s=>`<option value="${s.id}">${s.name} ‚Äî ${s.slug}</option>`).join('');
    if(shops.length) loadChecklist(shops[0].id);
  }

  // Checklist
  async function loadChecklist(shopId){
    const data = await fetch(`/api/check-items?shop_id=${encodeURIComponent(shopId)}`).then(r=>r.json());
    document.querySelector('#ciTable tbody').innerHTML = (data.items||[]).map(i=>`
      <tr>
        <td>${i.position}</td><td>${i.label}</td><td>${i.kind}</td>
        <td>${i.kind==='temperature' ? `${i.min ?? ''}‚Äì${i.max ?? ''} ${i.unit||''}` : '‚Äî'}</td>
        <td><button class="btn bad small" data-del-item="${i.id}">Remove</button></td>
      </tr>`).join('') || '<tr><td colspan="5">No items yet</td></tr>';
  }

  // Actions
  async function createUser(){
    const email=document.getElementById('uEmail').value.trim();
    const password=document.getElementById('uPass').value;
    const role=document.getElementById('uRole').value;
    const msg=document.getElementById('userMsg'); msg.textContent='‚Ä¶';
    const out = await Bunca.api('/api/users','POST',{email,password,role});
    msg.textContent = out.ok?'Created':(out.error||'Error');
    Bunca.toast(out.ok?'User created':'Failed to create user', out.ok?'':'err');
    if(out.ok) loadUsers();
  }

  async function createShop(){
    const body = {
      name:document.getElementById('sName').value.trim(),
      slug:document.getElementById('sSlug').value.trim(),
      address:document.getElementById('sAddress').value.trim(),
      phone:document.getElementById('sPhone').value.trim(),
      image_url:document.getElementById('sImg').value.trim(),
      description:document.getElementById('sDesc').value.trim(),
      status:document.getElementById('sStatus').value
    };
    const msg=document.getElementById('shopMsg'); msg.textContent='‚Ä¶';
    const out = await Bunca.api('/api/shops','POST', body);
    msg.textContent = out.ok?'Saved':(out.error||'Error');
    Bunca.toast(out.ok?'Shop saved':'Failed to save shop', out.ok?'':'err');
    if(out.ok) loadShops();
  }

  async function addItem(){
    const shop_id=document.getElementById('ciShop').value;
    const label=document.getElementById('ciLabel').value.trim();
    const kind=document.getElementById('ciKind').value;
    const position=Number(document.getElementById('ciPos').value||0);
    const min=document.getElementById('ciMin').value!==''?Number(document.getElementById('ciMin').value):null;
    const max=document.getElementById('ciMax').value!==''?Number(document.getElementById('ciMax').value):null;
    const unit=document.getElementById('ciUnit').value.trim()||'¬∞C';
    const msg=document.getElementById('ciMsg'); msg.textContent='‚Ä¶';
    const out = await Bunca.api('/api/check-items','POST',{shop_id,label,kind,position,min,max,unit});
    msg.textContent = out.ok?'Added':(out.error||'Error');
    Bunca.toast(out.ok?'Item added':'Failed to add item', out.ok?'':'err');
    if(out.ok){ loadChecklist(shop_id); document.getElementById('ciLabel').value=''; }
  }

  async function onClickRow(e){
    const u = e.target.closest('[data-del-user]');
    if(u && confirm('Delete user?')){ await Bunca.api('/api/users/'+u.dataset.delUser,'DELETE'); loadUsers(); Bunca.toast('User deleted'); }
    const s = e.target.closest('[data-del-shop]');
    if(s && confirm('Delete shop?')){ await Bunca.api('/api/shops/'+s.dataset.delShop,'DELETE'); loadShops(); Bunca.toast('Shop deleted'); }
    const i = e.target.closest('[data-del-item]');
    if(i && confirm('Remove item from checklist?')){ await Bunca.api('/api/check-items/'+i.dataset.delItem,'DELETE'); loadChecklist(document.getElementById('ciShop').value); Bunca.toast('Item removed'); }
  }
</script>
</body>
</html>
