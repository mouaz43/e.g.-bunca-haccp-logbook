<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BUNCA HACCP • Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>body{background:#f4f6f8}.brandbar{background:#1f7a3f}</style>
</head>
<body>
<nav class="navbar navbar-dark brandbar">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/index.html">BUNCA HACCP</a>
    <div class="ms-auto">
      <a class="btn btn-outline-light btn-sm" href="/index.html">Übersicht</a>
    </div>
  </div>
</nav>

<main class="container my-4">
  <h1 class="h4 mb-3">Adminbereich</h1>

  <ul class="nav nav-pills mb-3" id="tabs">
    <li class="nav-item"><button class="nav-link active" data-tab="shops">Shops</button></li>
    <li class="nav-item"><button class="nav-link" data-tab="users">Mitarbeiter</button></li>
  </ul>

  <!-- Shops -->
  <section id="tab-shops">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 mb-0">Shops</h2>
      <button id="btnNewShop" class="btn btn-success btn-sm">Neuer Shop</button>
    </div>
    <div class="card">
      <div class="table-responsive">
        <table class="table align-middle mb-0" id="shopsTable">
          <thead class="table-light"><tr>
            <th>Name</th><th>Stadt</th><th>Adresse</th><th>Aktiv</th><th>Zielwerte</th><th class="text-end">Aktion</th>
          </tr></thead><tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Users -->
  <section id="tab-users" class="d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 mb-0">Mitarbeiter</h2>
      <button id="btnNewUser" class="btn btn-success btn-sm">Mitarbeiter hinzufügen</button>
    </div>
    <div class="card">
      <div class="table-responsive">
        <table class="table align-middle mb-0" id="usersTable">
          <thead class="table-light"><tr>
            <th>Name</th><th>E-Mail</th><th>Rolle</th><th>Shops</th><th class="text-end">Aktion</th>
          </tr></thead><tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- simple modals -->
<div class="modal fade" id="modalBox" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title" id="modalTitle"></h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer">
      <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Abbrechen</button>
      <button id="modalSave" class="btn btn-success">Speichern</button>
    </div>
  </div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const token = localStorage.getItem('token');
  const role  = localStorage.getItem('role');
  if (!token || role !== 'admin') { alert('Nur für Admins.'); location.href = '/index.html'; }

  async function authFetch(url, opts={}) {
    const h = opts.headers || {};
    h['Authorization'] = 'Bearer ' + token;
    if (!h['Content-Type'] && opts.method && opts.method !== 'GET') h['Content-Type'] = 'application/json';
    const r = await fetch(url, { ...opts, headers: h });
    if (r.status === 401 || r.status === 403) { alert('Zugriff verweigert'); location.href='/index.html'; }
    return r;
  }

  // tabs
  document.querySelectorAll('#tabs .nav-link').forEach(btn=>{
    btn.onclick=()=>{
      document.querySelectorAll('#tabs .nav-link').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-shops').classList.toggle('d-none', btn.dataset.tab!=='shops');
      document.getElementById('tab-users').classList.toggle('d-none', btn.dataset.tab!=='users');
    };
  });

  // ----- shops -----
  const shopsBody = document.querySelector('#shopsTable tbody');
  async function loadShops(){
    const r = await authFetch('/api/admin/shops'); const shops = await r.json();
    shopsBody.innerHTML = shops.map(s=>`
      <tr>
        <td>${s.name}</td><td>${s.city||''}</td><td>${s.address||''}</td>
        <td>${s.isActive?'<span class="badge text-bg-success">aktiv</span>':'<span class="badge text-bg-secondary">inaktiv</span>'}</td>
        <td>KS1 ${s.targets.fridge1Min}–${s.targets.fridge1Max}°C, KS2 ${s.targets.fridge2Min}–${s.targets.fridge2Max}°C, TK ≤${s.targets.freezerMax}°C, Ofen ≥${s.targets.ovenMin}°C</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-edit="${s.id}">Bearbeiten</button>
          <button class="btn btn-sm btn-outline-danger ms-2" data-del="${s.id}">Löschen</button>
        </td>
      </tr>`).join('');
    shopsBody.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>editShop(b.dataset.edit));
    shopsBody.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>delShop(b.dataset.del));
    window._shopsCache = shops;
  }
  document.getElementById('btnNewShop').onclick = ()=>editShop(null);

  function shopForm(s={targets:{}}){
    return `
      <div class="row g-2">
        <div class="col-12"><label class="form-label">Name</label><input id="s-name" class="form-control" value="${s.name||''}"></div>
        <div class="col-6"><label class="form-label">Stadt</label><input id="s-city" class="form-control" value="${s.city||''}"></div>
        <div class="col-6"><label class="form-label">Adresse</label><input id="s-address" class="form-control" value="${s.address||''}"></div>
        <div class="col-6 mt-2 form-check ms-2"><input id="s-active" class="form-check-input" type="checkbox" ${s.isActive!==false?'checked':''}><label class="form-check-label">Aktiv</label></div>
        <div class="col-12"><hr></div>
        <div class="col-3"><label class="form-label">KS1 min</label><input id="t-f1min" class="form-control" type="number" value="${s.targets.fridge1Min??0}"></div>
        <div class="col-3"><label class="form-label">KS1 max</label><input id="t-f1max" class="form-control" type="number" value="${s.targets.fridge1Max??7}"></div>
        <div class="col-3"><label class="form-label">KS2 min</label><input id="t-f2min" class="form-control" type="number" value="${s.targets.fridge2Min??0}"></div>
        <div class="col-3"><label class="form-label">KS2 max</label><input id="t-f2max" class="form-control" type="number" value="${s.targets.fridge2Max??7}"></div>
        <div class="col-6"><label class="form-label">TK max</label><input id="t-fzmax" class="form-control" type="number" value="${s.targets.freezerMax??-18}"></div>
        <div class="col-6"><label class="form-label">Ofen min</label><input id="t-ovmin" class="form-control" type="number" value="${s.targets.ovenMin??180}"></div>
      </div>`;
  }

  async function editShop(id){
    const s = id ? window._shopsCache.find(x=>x.id===id) : {};
    const modal = new bootstrap.Modal('#modalBox');
    document.getElementById('modalTitle').textContent = id ? 'Shop bearbeiten' : 'Neuer Shop';
    document.getElementById('modalBody').innerHTML = shopForm(s);
    document.getElementById('modalSave').onclick = async ()=>{
      const body = {
        name: document.getElementById('s-name').value.trim(),
        city: document.getElementById('s-city').value.trim(),
        address: document.getElementById('s-address').value.trim(),
        isActive: document.getElementById('s-active').checked,
        targets: {
          fridge1Min: Number(document.getElementById('t-f1min').value),
          fridge1Max: Number(document.getElementById('t-f1max').value),
          fridge2Min: Number(document.getElementById('t-f2min').value),
          fridge2Max: Number(document.getElementById('t-f2max').value),
          freezerMax: Number(document.getElementById('t-fzmax').value),
          ovenMin: Number(document.getElementById('t-ovmin').value)
        }
      };
      const url = id ? '/api/admin/shops/'+id : '/api/admin/shops';
      const method = id ? 'PUT' : 'POST';
      await authFetch(url, { method, body: JSON.stringify(body) });
      modal.hide(); loadShops(); loadUsers();
    };
    modal.show();
  }
  async function delShop(id){
    if (!confirm('Diesen Shop löschen?')) return;
    await authFetch('/api/admin/shops/'+id, { method:'DELETE' });
    loadShops(); loadUsers();
  }

  // ----- users -----
  const usersBody = document.querySelector('#usersTable tbody');
  document.getElementById('btnNewUser').onclick = ()=>editUser(null);

  function userForm(u={}){
    const shops = window._shopsCache||[];
    const options = shops.map(s=>`<option value="${s.id}" ${u.shops&&u.shops.includes(s.id)?'selected':''}>${s.name}</option>`).join('');
    return `
      <div class="mb-2"><label class="form-label">Name</label><input id="u-name" class="form-control" value="${u.name||''}"></div>
      <div class="mb-2"><label class="form-label">E-Mail</label><input id="u-email" class="form-control" value="${u.email||''}"></div>
      <div class="mb-2"><label class="form-label">Rolle</label>
        <select id="u-role" class="form-select">
          <option value="staff" ${u.role==='staff'?'selected':''}>Mitarbeiter</option>
          <option value="manager" ${u.role==='manager'?'selected':''}>Shop-Manager</option>
          <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
        </select>
      </div>
      <div class="mb-2"><label class="form-label">Shops</label>
        <select id="u-shops" class="form-select" multiple>${options}</select>
      </div>
      <div class="mb-2"><label class="form-label">Temp-Passwort (nur beim Anlegen/Reset)</label><input id="u-pass" class="form-control" placeholder="z. B. Bunca2025!"></div>`;
  }

  async function loadUsers(){
    const r = await authFetch('/api/admin/users'); const users = await r.json();
    usersBody.innerHTML = users.map(u=>`
      <tr>
        <td>${u.name||''}</td>
        <td>${u.email}</td>
        <td><span class="badge text-bg-info">${u.role}</span></td>
        <td>${(u.shops||[]).map(id => (window._shopsCache||[]).find(s=>s.id===id)?.name || id).join(', ')}</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-primary" data-edit="${u.id}">Bearbeiten</button>
          <button class="btn btn-sm btn-outline-warning ms-2" data-reset="${u.id}">Passwort reset</button>
          <button class="btn btn-sm btn-outline-danger ms-2" data-del="${u.id}">Löschen</button>
        </td>
      </tr>`).join('');
    usersBody.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>editUser(b.dataset.edit));
    usersBody.querySelectorAll('[data-reset]').forEach(b=>b.onclick=()=>resetPass(b.dataset.reset));
    usersBody.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>delUser(b.dataset.del));
  }

  async function editUser(id){
    const r = await authFetch('/api/admin/users'); const users = await r.json();
    const u = id ? users.find(x=>x.id===id) : {};
    const modal = new bootstrap.Modal('#modalBox');
    document.getElementById('modalTitle').textContent = id ? 'Mitarbeiter bearbeiten' : 'Mitarbeiter hinzufügen';
    document.getElementById('modalBody').innerHTML = userForm(u);
    document.getElementById('modalSave').onclick = async ()=>{
      const body = {
        name: document.getElementById('u-name').value.trim(),
        email: document.getElementById('u-email').value.trim(),
        role: document.getElementById('u-role').value,
        shops: Array.from(document.getElementById('u-shops').selectedOptions).map(o=>o.value),
      };
      if (!id) body.tempPassword = document.getElementById('u-pass').value.trim();
      const url = id ? '/api/admin/users/'+id : '/api/admin/users';
      const method = id ? 'PUT' : 'POST';
      await authFetch(url, { method, body: JSON.stringify(body) });
      modal.hide(); loadUsers();
    };
    modal.show();
  }
  async function resetPass(id){
    const temp = prompt('Neues temporäres Passwort:'); if (!temp) return;
    await authFetch('/api/admin/users/'+id+'/reset-password', { method:'POST', body: JSON.stringify({ tempPassword: temp }) });
    alert('Passwort gesetzt.');
  }
  async function delUser(id){
    if (!confirm('Diesen Benutzer löschen?')) return;
    await authFetch('/api/admin/users/'+id, { method:'DELETE' });
    loadUsers();
  }

  // boot
  (async function(){
    await loadShops();
    await loadUsers();
  })();
</script>
</body>
</html>
